<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è–©è«¾ç“¦ç¾©å¼å»šæˆ¿</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root {
      /* ä¿®æ”¹å“ç‰Œè‰²ç‚ºç´…è‰²ç³» */
      --brand-main: #B91C1C; /* æ·±ç´… */
      --brand-light: #FEF2F2; /* æ·ºç´… */
      --brand-accent: #EF4444; /* äº®ç´… */
      --bg-color: #f8fafc;
    }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", Roboto, sans-serif; 
      background-color: var(--bg-color); 
      margin: 0; padding: 0; overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-slide-up { animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    .input-field { 
      @apply w-full p-4 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-[#B91C1C] focus:border-transparent outline-none transition-all text-base; 
    }
    .label-text { 
      @apply text-xs font-bold text-gray-500 mb-2 block uppercase tracking-wider ml-1; 
    }
    
    /* Hide scrollbar for horizontal scroll */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>

  <script type="module">
    import React, { useState, useEffect, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
    import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';

    const LIFF_ID = "2008861231-EA0Hpl68";
    const RESTAURANT_NAME = "è–©è«¾ç“¦ç¾©å¼å»šæˆ¿";
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxHOJOzIGqCnW-ttjB0_OeJ6eIz3iqF3dnYSwGeK4L2vRi6dEuWZ-i_DoM5pHjz9u7PlA/exec";

    const runGAS = async (action, params = {}) => {
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action, ...params })
        });
        return await response.json();
      } catch (err) {
        return { status: 'error', message: 'é€£ç·šå¤±æ•—' };
      }
    };

    const Icon = ({ name, className }) => {
      const paths = {
        menu: "M4 6h16M4 12h16M4 18h16",
        calendar: "M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z",
        map: "M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z",
        user: "M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z",
        gift: "M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7",
        back: "M10 19l-7-7m0 0l7-7m-7 7h18",
        phone: "M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z",
        star: "M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z",
        download: "M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4",
        close: "M6 18L18 6M6 6l12 12",
        trash: "M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16",
        edit: "M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z",
        cart: "M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z",
        question: "M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4 0 .742-.215 1.42-.588 2H12v2h3.535a4.004 4.004 0 01-7.07 0H5V9h3.228zM12 4a8 8 0 100 16 8 8 0 000-16z",
        info: "M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z",
        ticket: "M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z",
        history: "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z",
        stamp: "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z",
        search: "M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z",
        chevronDown: "M19 9l-7 7-7-7",
        share: "M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z",
        qr: "M12 4v1m6 11h2m-6 0h-2v4h2v-4zm-6 2v6h6v-6h-6zm2 2h2v2H8v-2zm12-2v2h2v-2h-2zm-2-2v2h2v-2h-2zm2-2v2h2v-2h-2zm-2-2v2h2v-2h-2zm2-2v2h2v-2h-2zm-6 0h-6v6h6v-6zm-2 2H8v2h2v-2zm6-8h-6v6h6v-6zm-2 2h-2v2h2v-2z",
        check: "M5 13l4 4L19 7"
      };
      return React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", className, fill: "none", viewBox: "0 0 24 24", stroke: "currentColor", strokeWidth: "2" },
        React.createElement("path", { strokeLinecap: "round", strokeLinejoin: "round", d: paths[name] || "" })
      );
    };

    const App = () => {
      const [view, setView] = useState('HOME');
      const [loading, setLoading] = useState(true);
      const [data, setData] = useState({ member: null, faqs: [], promotions: [], slotSettings: {}, bookingsSummary: [], chefRecommendations: [], restaurantMenu: [] });
      const [profile, setProfile] = useState(null);
      const [currentBooking, setCurrentBooking] = useState(null);
      
      const handleMemberUpdate = (member) => {
          setData(prev => ({ ...prev, member }));
      };
      const handleMemberDelete = () => setData(prev => ({...prev, member: null}));
      const handleBookingSuccess = (booking) => {
        setCurrentBooking(booking);
        setView('PREORDER');
      };

      useEffect(() => {
        const init = async () => {
          let currentUserId = '';
          try {
            if (window.liff) {
              await window.liff.init({ liffId: LIFF_ID });
              if (window.liff.isLoggedIn()) {
                const p = await window.liff.getProfile();
                const token = window.liff.getDecodedIDToken();
                if(token && token.email) p.email = token.email; 
                setProfile(p);
                currentUserId = p.userId;
              }
            }
          } catch (e) { console.warn("LIFF init failed"); }

          const res = await runGAS('getInitialData', { lineUserId: currentUserId });
          if (res.status === 'success') setData(res);
          setLoading(false);
        };
        init();
      }, []);

      if (loading) return (
        React.createElement("div", { className: "fixed inset-0" },
          React.createElement("img", { src: "https://i.ibb.co/93NGBjjh/IMG-6773.jpg", className: "w-full h-full object-cover" })
        )
      );

      const BaseView = ({ title, children, onBack }) => (
        React.createElement("div", { className: "flex flex-col h-screen bg-white animate-fade-in" },
          /* ä¹³ç™½è‰²èƒŒæ™¯ + ç´…è‰²æ–‡å­—èˆ‡åœ–ç¤º */
          React.createElement("div", { className: "bg-[#fdfbf7] text-[#B91C1C] p-4 flex items-center shadow-sm border-b border-[#B91C1C]/10 h-16 shrink-0 z-50" },
            React.createElement("button", { onClick: onBack, className: "mr-3 p-2 rounded-full hover:bg-[#B91C1C]/10 transition-colors" }, React.createElement(Icon, { name: "back", className: "w-6 h-6" })),
            React.createElement("h2", { className: "text-xl font-bold tracking-wide" }, title)
          ),
          React.createElement("div", { className: "flex-1 overflow-y-auto pb-safe" }, children)
        )
      );
      
      const goHome = () => setView('HOME');

      switch(view) {
        case 'HOME': return React.createElement(HomeView, { setView, profile, data });
        case 'MENU': return React.createElement(BaseView, { title: "ç²¾ç·»èœå–®", onBack: goHome }, React.createElement(MenuView, { chefRecommendations: data.chefRecommendations }));
        case 'LOCATION': return React.createElement(BaseView, { title: "åº—å®¶è³‡è¨Š", onBack: goHome }, React.createElement(LocationView, { profile }));
        case 'NEWS': return React.createElement(BaseView, { title: "æ´»å‹•èˆ‡å„ªæƒ ", onBack: goHome }, React.createElement(NewsView, { promotions: data.promotions }));
        case 'FAQ': return React.createElement(BaseView, { title: "å¸¸è¦‹å•é¡Œ", onBack: goHome }, React.createElement(FaqView, { faqs: data.faqs }));
        case 'BOOKING': return React.createElement(BaseView, { title: "ç·šä¸Šè¨‚ä½", onBack: goHome }, React.createElement(BookingView, { member: data.member, profile, data, onBack: goHome, onBookingSuccess: handleBookingSuccess }));
        case 'MEMBER': return React.createElement(BaseView, { title: "æœƒå“¡ä¸­å¿ƒ", onBack: goHome }, React.createElement(MemberView, { member: data.member, profile, onMemberUpdate: handleMemberUpdate, onMemberDelete: handleMemberDelete, setView }));
        case 'PREORDER': return React.createElement(BaseView, { title: "é å…ˆé»é¤", onBack: goHome }, React.createElement(PreorderView, { booking: currentBooking, restaurantMenu: data.restaurantMenu, onBack: goHome }));
        case 'MY_BOOKINGS': return React.createElement(BaseView, { title: "æˆ‘çš„è¨‚ä½", onBack: () => setView('MEMBER') }, React.createElement(MyBookingsView, { profile }));
        case 'POINT_HISTORY': return React.createElement(BaseView, { title: "é»æ•¸ç´€éŒ„", onBack: () => setView('MEMBER') }, React.createElement(PointHistoryView, { profile }));
        case 'COUPONS': return React.createElement(BaseView, { title: "æˆ‘çš„å„ªæƒ åˆ¸", onBack: () => setView('MEMBER') }, React.createElement(CouponsView, { profile }));
        case 'STAMP_CARD': return React.createElement(BaseView, { title: "é›†é»å¡", onBack: () => setView('MEMBER') }, React.createElement(StampCardView, { profile }));
        default: return React.createElement(HomeView, { setView, profile, data });
      }
    };

    const HomeView = ({ setView, profile, data }) => {
      const handleNavClick = (id) => {
        // Enforce member check for Booking
        if (id === 'BOOKING' && !data.member) {
          Swal.fire({
            title: 'éæœƒå“¡ç„¡æ³•ç·šä¸Šè¨‚ä½',
            text: 'è«‹å…ˆå®Œæˆè¨»å†Šæˆç‚ºæœƒå“¡ï¼Œæ–¹å¯ä½¿ç”¨ç·šä¸Šè¨‚ä½æœå‹™ã€‚',
            icon: 'warning',
            confirmButtonText: 'å‰å¾€è¨»å†Š',
            confirmButtonColor: '#B91C1C',
            showCancelButton: true,
            cancelButtonText: 'å–æ¶ˆ'
          }).then((result) => {
            if (result.isConfirmed) {
                setView('MEMBER'); // Navigate to Member view which shows Registration form
            }
          });
          return;
        }
        setView(id);
      };

      return React.createElement("div", { className: "flex flex-col h-full bg-[#f8fafc]" },
        React.createElement("div", { className: "bg-white p-5 sticky top-0 z-10 flex justify-between items-center shadow-sm h-18 shrink-0" },
          React.createElement("div", null,
             React.createElement("p", { className: "text-xs text-gray-400 font-bold uppercase tracking-wider" }, RESTAURANT_NAME),
             React.createElement("h1", { className: "font-bold text-[#B91C1C] text-lg" }, 
                profile?.displayName ? `${profile.displayName}, æ‚¨å¥½` : "Welcome"
             )
          ),
          profile && React.createElement("img", { src: profile.pictureUrl, className: "w-10 h-10 rounded-full border-2 border-[#B91C1C] shadow-sm" })
        ),
        React.createElement("div", { className: "flex-1 overflow-y-auto p-5 space-y-6" },
          React.createElement("div", { className: "relative h-56 rounded-3xl overflow-hidden shadow-2xl transform transition-all hover:scale-[1.01]" },
            React.createElement("img", { src: "https://i.ibb.co/qLFg7gSk/Gemini-Generated-Image-cmj4yzcmj4yzcmj4.png", className: "w-full h-full object-cover" }),
            React.createElement("div", { className: "absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent flex items-end p-6 text-white" },
              React.createElement("div", null,
                React.createElement("h3", { className: "font-bold text-2xl drop-shadow-md" }, "ç¾©å¼é¢¨å‘³ï¼Œç”¨å¿ƒå‘ˆç¾"),
                React.createElement("p", { className: "text-xs opacity-90 uppercase tracking-widest font-bold mt-1" }, "AUTHENTIC ITALIAN CUISINE")
              )
            )
          ),
          React.createElement("div", { className: "grid grid-cols-2 gap-4" },
            [
              { id: 'MENU', name: 'ç²¾ç·»èœå–®', icon: 'menu', from: 'from-orange-50', to: 'to-white', text: 'text-orange-600' },
              { id: 'BOOKING', name: 'ç·šä¸Šè¨‚ä½', icon: 'calendar', from: 'from-red-50', to: 'to-white', text: 'text-[#B91C1C]' },
              { id: 'MEMBER', name: 'æœƒå“¡ä¸­å¿ƒ', icon: 'user', from: 'from-pink-50', to: 'to-white', text: 'text-pink-600' },
              { id: 'NEWS', name: 'æ´»å‹•å„ªæƒ ', icon: 'gift', from: 'from-yellow-50', to: 'to-white', text: 'text-yellow-600' },
              { id: 'LOCATION', name: 'åº—å®¶è³‡è¨Š', icon: 'map', from: 'from-blue-50', to: 'to-white', text: 'text-blue-500' },
              { id: 'FAQ', name: 'å¸¸è¦‹å•é¡Œ', icon: 'question', from: 'from-gray-100', to: 'to-white', text: 'text-gray-600' }
            ].map(btn => (
              React.createElement("button", { key: btn.id, onClick: () => handleNavClick(btn.id), className: `h-36 bg-gradient-to-br ${btn.from} ${btn.to} rounded-3xl shadow-sm border border-white/50 flex flex-col items-center justify-center gap-3 active:scale-95 transition-all relative group hover:shadow-lg` },
                React.createElement("div", { className: `w-14 h-14 bg-white rounded-full flex items-center justify-center ${btn.text} shadow-md group-hover:scale-110 transition-transform`}, React.createElement(Icon, { name: btn.icon, className: "w-7 h-7" })),
                React.createElement("span", { className: "font-bold text-gray-700 text-base" }, btn.name)
              )
            ))
          ),
          React.createElement("p", { className: "text-center text-xs text-gray-300 py-4" }, "Â© 2024 Sanova Italian Kitchen")
        )
      )
    );
    };
    
    const MenuView = ({ chefRecommendations }) => {
        const [modalItem, setModalItem] = useState(null);
        const [dishModal, setDishModal] = useState(null);
        const [tab, setTab] = useState('FEATURED');
        
        const dishes = (chefRecommendations && chefRecommendations.length > 0) ? chefRecommendations : [];

        // Updated images
        const menuItems = [
            { src: "https://i.ibb.co/XZQx4dWc/S-36053013-0.jpg", full: "https://i.ibb.co/TDV3qsnx/2025-page-0001.jpg", label: "èœå–®æ­£é¢", filename: "sanova-menu-front.webp" },
            { src: "https://i.ibb.co/dsdPtQKN/S-36053012-0.jpg", full: "https://i.ibb.co/dCKyZ74/2025-page-0002.jpg", label: "èœå–®èƒŒé¢", filename: "sanova-menu-back.webp" }
        ];

        return React.createElement(React.Fragment, null,
            React.createElement("div", { className: "flex sticky top-0 bg-white z-10 shadow-sm" },
                React.createElement("button", { onClick: () => setTab('FEATURED'), className: `flex-1 py-3 font-bold text-sm border-b-2 transition-colors ${tab === 'FEATURED' ? 'border-[#B91C1C] text-[#B91C1C]' : 'border-transparent text-gray-500'}`}, "ä¸»å»šæ¨è–¦"),
                React.createElement("button", { onClick: () => setTab('FULL'), className: `flex-1 py-3 font-bold text-sm border-b-2 transition-colors ${tab === 'FULL' ? 'border-[#B91C1C] text-[#B91C1C]' : 'border-transparent text-gray-500'}`}, "å®Œæ•´èœå–®")
            ),
            React.createElement("div", { className: "p-6 space-y-8" },
                tab === 'FEATURED' ? 
                React.createElement("div", { className: "space-y-4" },
                    dishes.length === 0 ? React.createElement("p", {className: "text-center text-gray-400"}, "ç›®å‰æ²’æœ‰ä¸»å»šæ¨è–¦é …ç›®ã€‚") :
                    dishes.map((d, i) => React.createElement("div", { key: i, onClick: () => setDishModal(d), className: "bg-white rounded-xl shadow-md overflow-hidden border border-gray-100 flex cursor-pointer hover:shadow-lg transition-shadow" },
                        React.createElement("img", { src: d['åœ–ç‰‡ç¶²å€'], className: "w-28 h-28 object-cover shrink-0" }),
                        React.createElement("div", { className: "p-3 flex flex-col justify-center flex-1" },
                             React.createElement("h4", { className: "font-bold text-gray-800" }, d['ç”¢å“åç¨±']),
                             React.createElement("p", { className: "text-xs text-gray-500 mt-1 line-clamp-2" }, d['ç”¢å“èªªæ˜']),
                             React.createElement("p", { className: "text-[#B91C1C] font-bold mt-2" }, `$${d['ç”¢å“åƒ¹æ ¼']}`)
                        )
                    ))
                ) :
                menuItems.map(item =>
                    React.createElement("div", { key: item.src, className: "text-center" },
                        React.createElement("p", { className: "font-bold text-gray-600 mb-2 text-sm" }, item.label),
                        React.createElement("img", {
                            src: item.src,
                            className: "w-full rounded-lg shadow-lg cursor-pointer transition-transform hover:scale-105 duration-300",
                            onClick: () => setModalItem(item)
                        })
                    )
                )
            ),
            modalItem && React.createElement("div", {
                    className: "fixed inset-0 bg-black/80 flex flex-col items-center justify-center z-50 animate-fade-in p-4",
                    onClick: () => setModalItem(null)
                },
                React.createElement("button", {
                    className: "absolute top-5 right-5 bg-white/20 backdrop-blur-sm text-white rounded-full p-2 hover:bg-white/30 transition-all z-20",
                    onClick: () => setModalItem(null)
                }, React.createElement(Icon, { name: "close", className: "w-7 h-7" })),
                React.createElement("div", {
                        className: "flex flex-col items-center",
                        onClick: e => e.stopPropagation()
                    },
                    React.createElement("img", {
                        src: modalItem.full,
                        className: "max-w-full max-h-[75vh] rounded-lg shadow-2xl object-contain"
                    }),
                    React.createElement("a", {
                        href: modalItem.full,
                        download: modalItem.filename,
                        className: "mt-4 inline-flex items-center justify-center gap-2 bg-[#B91C1C] text-white px-5 py-3 rounded-lg text-sm font-bold shadow-md hover:bg-opacity-90 transition-all"
                    }, React.createElement(Icon, { name: "download", className: "w-5 h-5" }), "ä¸‹è¼‰èœå–®")
                )
            ),
            dishModal && React.createElement("div", {
                className: "fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in",
                onClick: () => setDishModal(null)
            },
                React.createElement("div", { 
                    className: "bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl animate-slide-up",
                    onClick: e => e.stopPropagation() 
                },
                    React.createElement("div", { className: "relative h-64" },
                        React.createElement("img", { src: dishModal['åœ–ç‰‡ç¶²å€'], className: "w-full h-full object-cover" }),
                        React.createElement("button", { 
                            onClick: () => setDishModal(null),
                            className: "absolute top-3 right-3 bg-black/30 text-white p-1 rounded-full backdrop-blur-md hover:bg-black/50 transition-colors"
                        }, React.createElement(Icon, {name:"close", className:"w-6 h-6"}))
                    ),
                    React.createElement("div", { className: "p-6" },
                        React.createElement("div", { className: "flex justify-between items-start mb-2" },
                             React.createElement("h3", { className: "text-2xl font-bold text-gray-800" }, dishModal['ç”¢å“åç¨±']),
                             React.createElement("span", { className: "text-xl font-bold text-[#B91C1C]" }, `$${dishModal['ç”¢å“åƒ¹æ ¼']}`)
                        ),
                        React.createElement("div", { className: "h-px bg-gray-100 my-4" }),
                        React.createElement("p", { className: "text-gray-600 leading-relaxed text-sm" }, dishModal['ç”¢å“èªªæ˜']),
                        React.createElement("button", {
                            onClick: () => setDishModal(null),
                            className: "w-full mt-6 bg-[#B91C1C] text-white py-3 rounded-xl font-bold shadow-lg shadow-red-200 active:scale-95 transition-transform"
                        }, "é—œé–‰")
                    )
                )
            )
        );
    };

    // MyBookingsView - Fix date parsing issues
    const MyBookingsView = ({ profile }) => {
        const [bookings, setBookings] = useState([]);
        const [loading, setLoading] = useState(true);
        useEffect(() => {
            if(!profile) return;
            runGAS('getUserBookings', { lineUserId: profile.userId })
                .then(res => {
                    if (res.status === 'success') setBookings(res.bookings.reverse());
                })
                .finally(() => setLoading(false));
        }, [profile]);

        if (loading) return React.createElement("p", {className: "text-center p-8"}, "è®€å–ä¸­...");
        if (bookings.length === 0) return React.createElement("p", {className: "text-center text-gray-500 p-8"}, "æ‚¨ç›®å‰æ²’æœ‰ä»»ä½•è¨‚ä½ç´€éŒ„ã€‚");

        return React.createElement("div", {className: "p-4 space-y-4"},
            bookings.map((b, i) => {
                // Safer date handling
                let dateDisplay = b['é ç´„æ—¥æœŸ'];
                try {
                    const dateObj = new Date(b['é ç´„æ—¥æœŸ']);
                    if (!isNaN(dateObj.getTime())) {
                        dateDisplay = dateObj.toLocaleDateString();
                    }
                } catch(e) {}

                return React.createElement("div", {key: i, className: "bg-white p-4 rounded-xl shadow-sm border border-gray-100"},
                    React.createElement("div", { className: "flex justify-between items-start" },
                        React.createElement("div", null,
                            React.createElement("div", { className: "flex items-center gap-2 mb-1" },
                                React.createElement("span", { className: "text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded font-mono" }, b['è¨‚ä½ä»£è™Ÿ'] || '---'),
                                React.createElement("p", {className: "font-bold text-lg text-gray-800"}, dateDisplay)
                            ),
                            React.createElement("p", {className: "text-[#B91C1C] font-bold"}, b['é ç´„æ™‚é–“'])
                        ),
                        React.createElement("span", { className: "bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded" }, `${b['å¤§äºº']}å¤§${b['å°å­©']}å°`)
                    ),
                    b['é é»é¤'] && React.createElement("div", {className: "mt-3 pt-3 border-t border-dashed border-gray-200"},
                        React.createElement("p", {className: "text-xs text-gray-500 mb-1"}, "é é»é¤é»"),
                        React.createElement("p", {className: "text-sm text-gray-700 whitespace-pre-wrap"}, b['é é»é¤'].replace(/;/g, '\n'))
                    )
                );
            })
        );
    };

    // PreorderView - Completely Overhauled
    const PreorderView = ({ booking, restaurantMenu, onBack }) => {
        // Initial Mock Data (Fallback) based on the user's provided list
        // This structure allows for the complex logic requested.
        const fallbackMenu = [
            { category: "ç¾©å¤§åˆ©éºµ", sub: "ä¸»å»šæ¨è–¦", n: "å®®ä¿è¾£å‘³é›ä¸ç¾©å¤§åˆ©éºµ", p: 0 }, 
            { category: "ç¾©å¤§åˆ©éºµ", sub: "ä¸»å»šæ¨è–¦", n: "æ¥µå“X.Oé†¬æµ·é®®ç¾©å¤§åˆ©éºµ", p: 250, special: true },
            { category: "ç¾©å¤§åˆ©éºµ", sub: "ä¸»å»šæ¨è–¦", n: "å¢¨é­šæ±æµ·é®®å¢¨é­šéºµ", p: 260, special: true },
            { category: "ç¾©å¤§åˆ©éºµ", sub: "ç™½é†¬", n: "å¥¶æ²¹åŸ¹æ ¹ç¾©å¤§åˆ©éºµ", p: 170 },
            { category: "ç¾©å¤§åˆ©éºµ", sub: "ç™½é†¬", n: "å¥¶æ²¹è›¤èœŠç¾©å¤§åˆ©éºµ", p: 220 },
            { category: "ç¾©å¤§åˆ©éºµ", sub: "èŒ„æ±", n: "æ³¢éš†é‚£è‚‰é†¬ç¾©å¤§åˆ©éºµ", p: 170, tags: ['ç‰›'] },
            { category: "ç¾©å¼ç‡‰é£¯", sub: "åŸºæœ¬æ¬¾", n: "å—ç“œæ™‚è”¬ç‡‰é£¯", p: 180, tags: ['ç´ '] },
            { category: "PIZZA", sub: "", n: "ç¾©å¼è‚‰é†¬é‡è‡æŠ«è–©", p: 160, tags: ['ç‰›'] },
            { category: "å–®é»", sub: "ç‚¸ç‰©", n: "éº¥å…‹é›å¡Š", p: 80 },
            { category: "é£²å“", sub: "", n: "å¯æ¨‚", p: 50 },
        ];

        // Process menu data: prefer props.restaurantMenu, fallback to mock if empty
        const menuItems = (restaurantMenu && restaurantMenu.length > 0) 
            ? restaurantMenu.map(i => ({ category: i['é¡åˆ¥'], sub: i['å­é¡åˆ¥'], n: i['ç”¢å“åç¨±'], p: Number(i['ç”¢å“åƒ¹æ ¼']), img: i['åœ–ç‰‡ç¶²å€'], tags: i['æ¨™ç±¤'] ? i['æ¨™ç±¤'].split(',') : [] })) 
            : fallbackMenu;

        const categories = ["ç¾©å¤§åˆ©éºµ", "ç¾©å¼ç‡‰é£¯", "ç„—çƒ¤", "PIZZA", "å–®é»", "é£²å“"];
        const [activeCategory, setActiveCategory] = useState(categories[0]);
        const [cart, setCart] = useState([]);
        const [showCartModal, setShowCartModal] = useState(false);
        const [selectedItem, setSelectedItem] = useState(null); // Item for detail modal

        // Item Modal State
        const [itemOptions, setItemOptions] = useState({ noodle: 'ç­†å°–éºµ', spice: 'ä¸è¾£', combo: 0, drink: '' });

        const noodleOptions = [
            { n: "ç­†å°–éºµ", p: 0 }, { n: "å¤©ä½¿ç´°éºµ", p: 10 }, { n: "é€šå¿ƒéºµ", p: 10 }, { n: "ç´°æ‰éºµ", p: 10 }, { n: "å¢¨é­šéºµ", p: 40 }
        ];
        const spiceOptions = ["ä¸è¾£", "å°è¾£", "ä¸­è¾£", "å¤§è¾£"];
        const comboOptions = [
            { id: 0, n: "å–®é»", p: 0 },
            { id: 1, n: "è¶…å€¼å¥—é¤", p: 80, desc: "å«é£²å“" },
            { id: 2, n: "é…¥çš®å¥—é¤", p: 130, desc: "å«é£²å“+é…¥çš®æ¿ƒæ¹¯" }
        ];
        const drinkOptions = menuItems.filter(i => i.category === "é£²å“").map(i => i.n);

        // Open Modal
        const openItemModal = (item) => {
            setSelectedItem(item);
            // Default options
            setItemOptions({ 
                noodle: (item.category === "ç¾©å¤§åˆ©éºµ") ? 'ç­†å°–éºµ' : '', 
                spice: 'ä¸è¾£', 
                combo: 0, 
                drink: '' 
            });
        };

        const addToCartFromModal = () => {
            if (itemOptions.combo > 0 && !itemOptions.drink) {
                Swal.fire({ icon: 'warning', title: 'è«‹é¸æ“‡é£²æ–™', text: 'å¥—é¤å¿…é ˆé¸æ“‡é£²å“', confirmButtonColor: '#B91C1C' });
                return;
            }

            const itemTotal = selectedItem.p + (itemOptions.combo === 1 ? 80 : itemOptions.combo === 2 ? 130 : 0) + (noodleOptions.find(n=>n.n === itemOptions.noodle)?.p || 0);
            
            const newItem = {
                ...selectedItem,
                ...itemOptions,
                unitPrice: itemTotal,
                qty: 1,
                cartId: Date.now() // Unique ID for cart item (distinguish same product with diff options)
            };

            setCart(prev => [...prev, newItem]);
            setSelectedItem(null);
            Swal.fire({ icon: 'success', title: 'å·²åŠ å…¥è³¼ç‰©è»Š', showConfirmButton: false, timer: 800 });
        };

        const removeFromCart = (cartId) => {
            setCart(prev => prev.filter(i => i.cartId !== cartId));
        };

        const total = useMemo(() => cart.reduce((sum, item) => sum + item.unitPrice * item.qty, 0), [cart]);
        
        // Low Charge Calculation
        const minChargePerPerson = 60;
        const payingPeople = parseInt(booking?.adults) || 0; 
        const requiredTotal = minChargePerPerson * payingPeople;

        const handleSubmit = async () => {
            if (total < requiredTotal) {
                 Swal.fire({ 
                     icon: 'warning', 
                     title: 'æœªé”ä½æ¶ˆ', 
                     text: `æ¯äººä½æ¶ˆ $${minChargePerPerson} (ä¸å«å…’ç«¥)ã€‚\nç›®å‰è¨ˆè²»äººæ•¸ ${payingPeople} äººï¼Œç¸½é‡‘é¡éœ€é” $${requiredTotal}ã€‚\né‚„å·® $${requiredTotal - total}ã€‚`, 
                     confirmButtonColor: '#D32F2F' 
                 });
                 return;
            }

            const res = await runGAS('savePreOrder', { bookingId: booking.bookingId, order: cart });
            if(res.status === 'success') {
                if (window.liff.isInClient()) {
                    const orderText = cart.map(i => {
                        let desc = `${i.n}`;
                        if(i.noodle) desc += `(${i.noodle})`;
                        if(i.spice) desc += `[${i.spice}]`;
                        if(i.combo) desc += `+${comboOptions.find(c=>c.id===i.combo).n}`;
                        if(i.drink) desc += `/${i.drink}`;
                        desc += ` x${i.qty}`;
                        return desc;
                    }).join('\n');
                    
                    const fullMessage = booking.bookingMessageText + `\n\nğŸ” é é»é¤é»ç¢ºèªï¼š\n${orderText}\n\né é»é‡‘é¡ï¼š$${total}`;
                    await window.liff.sendMessages([{ type: 'text', text: fullMessage }]).catch(console.error);
                }
                setShowCartModal(false);
                await Swal.fire({ icon: 'success', title: 'é å…ˆé»é¤æˆåŠŸ', text: 'æ‚¨çš„é»é¤ç´€éŒ„å·²å„²å­˜ï¼ŒæœŸå¾…æ‚¨çš„å…‰è‡¨ï¼', confirmButtonColor: '#B91C1C'});
                onBack();
            } else {
                 Swal.fire({ icon: 'error', title: 'é»é¤å¤±æ•—', text: res.message, confirmButtonColor: '#D32F2F' });
            }
        };

        const filteredItems = menuItems.filter(i => i.category === activeCategory);
        // Group by subCategory (sauce) if Pasta/Risotto
        const groupedItems = filteredItems.reduce((acc, item) => {
            const key = item.sub || 'å…¶å®ƒ';
            if(!acc[key]) acc[key] = [];
            acc[key].push(item);
            return acc;
        }, {});

        return React.createElement("div", { className: "flex h-full relative" },
            /* Left Categories */
            React.createElement("div", { className: "w-[26%] bg-gray-50 overflow-y-auto border-r border-gray-100 pb-24" },
                categories.map(cat => React.createElement("button", { key: cat, onClick: () => setActiveCategory(cat), className: `w-full text-left px-2 py-4 text-xs font-bold transition-all border-l-4 ${activeCategory === cat ? 'bg-white text-[#B91C1C] border-[#B91C1C] shadow-sm' : 'text-gray-500 border-transparent hover:bg-gray-100'}` }, cat))
            ),
            /* Right Items */
            React.createElement("div", { className: "w-[74%] p-4 overflow-y-auto pb-36 bg-white" },
                React.createElement("div", { className: "bg-red-50 p-2 mb-4 rounded-lg text-[10px] text-red-700 font-bold border border-red-100 flex items-center gap-1" }, 
                   React.createElement(Icon, {name:"info", className:"w-3 h-3"}), `ä½æ¶ˆæé†’ï¼šå…±éœ€ $${requiredTotal}`
                ),
                Object.keys(groupedItems).map(sub => 
                    React.createElement("div", { key: sub, className: "mb-6" },
                        sub !== 'å…¶å®ƒ' && React.createElement("h4", { className: "font-bold text-gray-400 text-sm mb-2 sticky top-0 bg-white py-1" }, sub),
                        React.createElement("div", { className: "space-y-3" },
                            groupedItems[sub].map((item, idx) => 
                                React.createElement("div", { key: idx, onClick: () => openItemModal(item), className: "flex bg-white rounded-lg border border-gray-100 shadow-sm overflow-hidden active:scale-95 transition-transform cursor-pointer" },
                                    item.img && React.createElement("img", { src: item.img, className: "w-20 h-20 object-cover" }),
                                    React.createElement("div", { className: "p-2 flex-1 flex flex-col justify-between" },
                                        React.createElement("div", null,
                                            React.createElement("p", { className: "font-bold text-gray-800 text-sm leading-tight" }, item.n),
                                            React.createElement("div", { className: "flex gap-1 mt-1 flex-wrap" },
                                                item.tags && item.tags.includes('è¾£') && React.createElement("span", { className: "text-[9px] bg-red-100 text-red-600 px-1 rounded" }, "ğŸŒ¶ï¸"),
                                                item.tags && item.tags.includes('ç‰›') && React.createElement("span", { className: "text-[9px] bg-amber-100 text-amber-700 px-1 rounded" }, "ğŸ®"),
                                                item.tags && item.tags.includes('ç´ ') && React.createElement("span", { className: "text-[9px] bg-green-100 text-green-700 px-1 rounded" }, "ğŸ¥¦")
                                            )
                                        ),
                                        React.createElement("div", { className: "flex justify-between items-end" },
                                            React.createElement("p", { className: "font-bold text-[#B91C1C]" }, `$${item.p}`),
                                            React.createElement("div", { className: "bg-[#B91C1C] text-white w-5 h-5 rounded-full flex items-center justify-center font-bold text-lg" }, "+")
                                        )
                                    )
                                )
                            )
                        )
                    )
                )
            ),
            /* Floating Cart Bar */
            cart.length > 0 && !showCartModal && !selectedItem && React.createElement("div", { className: "fixed bottom-6 left-4 right-4 bg-[#B91C1C] text-white p-3 rounded-xl shadow-2xl z-30 flex justify-between items-center cursor-pointer active:scale-95 transition-transform animate-slide-up", onClick: () => setShowCartModal(true) },
                React.createElement("div", { className: "flex items-center gap-3" },
                    React.createElement("div", { className: "bg-white text-[#B91C1C] font-bold w-8 h-8 rounded-full flex items-center justify-center" }, cart.length),
                    React.createElement("span", { className: "font-bold text-lg" }, `$${total}`)
                ),
                React.createElement("span", { className: "font-bold text-sm" }, "æŸ¥çœ‹æ˜ç´° >")
            ),
            /* Item Detail Modal (Selection) */
            selectedItem && React.createElement("div", { className: "fixed inset-0 z-50 flex items-end justify-center bg-black/60 backdrop-blur-sm animate-fade-in" },
                React.createElement("div", { className: "bg-white w-full max-h-[90vh] rounded-t-2xl shadow-2xl flex flex-col animate-slide-up overflow-hidden" },
                    React.createElement("div", { className: "p-4 bg-gray-50 border-b flex justify-between items-start" },
                        React.createElement("div", null,
                            React.createElement("h3", { className: "font-bold text-lg text-gray-800" }, selectedItem.n),
                            React.createElement("p", { className: "text-[#B91C1C] font-bold" }, `$${selectedItem.p}`)
                        ),
                        React.createElement("button", { onClick: () => setSelectedItem(null), className: "bg-gray-200 rounded-full p-1" }, React.createElement(Icon, {name:"close", className:"w-5 h-5"}))
                    ),
                    React.createElement("div", { className: "flex-1 overflow-y-auto p-4 space-y-6" },
                        /* Noodle Selection */
                        selectedItem.category === "ç¾©å¤§åˆ©éºµ" && React.createElement("div", null,
                            React.createElement("h4", { className: "font-bold text-sm mb-2 flex items-center gap-1" }, "é¸æ“‡éºµæ¢", React.createElement("span", {className:"text-[10px] text-red-500"}, "*å¿…é¸")),
                            React.createElement("div", { className: "grid grid-cols-2 gap-2" },
                                noodleOptions.map(opt => React.createElement("button", { 
                                    key: opt.n, 
                                    onClick: () => setItemOptions({...itemOptions, noodle: opt.n}),
                                    className: `py-2 text-xs border rounded-lg ${itemOptions.noodle === opt.n ? 'bg-red-50 border-[#B91C1C] text-[#B91C1C] font-bold' : 'border-gray-200 text-gray-600'}` 
                                }, `${opt.n} ${opt.p > 0 ? `(+$${opt.p})` : ''}`))
                            )
                        ),
                        /* Spiciness */
                        React.createElement("div", null,
                            React.createElement("h4", { className: "font-bold text-sm mb-2" }, "è¾£åº¦èª¿æ•´"),
                            React.createElement("div", { className: "flex gap-2" },
                                spiceOptions.map(s => React.createElement("button", { 
                                    key: s, 
                                    onClick: () => setItemOptions({...itemOptions, spice: s}),
                                    className: `flex-1 py-2 text-xs border rounded-lg ${itemOptions.spice === s ? 'bg-red-50 border-[#B91C1C] text-[#B91C1C] font-bold' : 'border-gray-200 text-gray-600'}` 
                                }, s))
                            )
                        ),
                        /* Combo Upgrade */
                        React.createElement("div", { className: "bg-yellow-50 p-3 rounded-xl border border-yellow-200" },
                            React.createElement("h4", { className: "font-bold text-sm mb-2 text-yellow-800" }, "âœ¨ è¶…å€¼å‡ç´šï¼Ÿ"),
                            React.createElement("div", { className: "space-y-2" },
                                comboOptions.map(c => React.createElement("label", { key: c.id, className: "flex items-center justify-between p-2 bg-white rounded-lg border cursor-pointer" },
                                    React.createElement("div", { className: "flex items-center gap-2" },
                                        React.createElement("input", { type: "radio", name: "combo", checked: itemOptions.combo === c.id, onChange: () => setItemOptions({...itemOptions, combo: c.id, drink: ''}), className: "accent-[#B91C1C]" }),
                                        React.createElement("div", null,
                                            React.createElement("p", { className: "text-sm font-bold" }, c.n),
                                            c.desc && React.createElement("p", { className: "text-[10px] text-gray-500" }, c.desc)
                                        )
                                    ),
                                    React.createElement("span", { className: "text-xs font-bold text-[#B91C1C]" }, `+$${c.p}`)
                                ))
                            )
                        ),
                        /* Drink Selection (Conditional) */
                        itemOptions.combo > 0 && React.createElement("div", { className: "animate-fade-in" },
                            React.createElement("h4", { className: "font-bold text-sm mb-2 flex items-center gap-1" }, "é¸æ“‡é£²å“", React.createElement("span", {className:"text-[10px] text-red-500"}, "*å¿…é¸")),
                            React.createElement("select", { 
                                value: itemOptions.drink, 
                                onChange: (e) => setItemOptions({...itemOptions, drink: e.target.value}),
                                className: "w-full p-2 border border-gray-300 rounded-lg text-sm bg-white"
                            },
                                React.createElement("option", { value: "" }, "è«‹é¸æ“‡é£²æ–™..."),
                                drinkOptions.map(d => React.createElement("option", { key: d, value: d }, d))
                            )
                        )
                    ),
                    React.createElement("div", { className: "p-4 border-t bg-white pb-safe" },
                        React.createElement("button", { onClick: addToCartFromModal, className: "w-full bg-[#B91C1C] text-white py-3 rounded-xl font-bold shadow-lg shadow-red-200 active:scale-95 transition-transform" }, "åŠ å…¥è³¼ç‰©è»Š")
                    )
                )
            ),
            /* Cart Modal */
            showCartModal && React.createElement("div", { className: "fixed inset-0 z-50 flex items-end justify-center bg-black/50 backdrop-blur-sm animate-fade-in" },
                React.createElement("div", { className: "bg-white w-full max-h-[85vh] rounded-t-3xl shadow-2xl flex flex-col animate-slide-up" },
                    React.createElement("div", { className: "p-4 border-b border-gray-100 flex justify-between items-center" },
                        React.createElement("h3", { className: "font-bold text-xl text-gray-800" }, "æ‚¨çš„é¤é»"),
                        React.createElement("button", { onClick: () => setShowCartModal(false), className: "p-2 bg-gray-100 rounded-full text-gray-600" }, React.createElement(Icon, {name: "chevronDown", className: "w-6 h-6"}))
                    ),
                    React.createElement("div", { className: "flex-1 overflow-y-auto p-4 space-y-4" },
                        cart.map(item => React.createElement("div", { key: item.cartId, className: "flex justify-between items-start bg-white border-b border-gray-50 pb-2 last:border-0" },
                            React.createElement("div", null, 
                                React.createElement("p", { className: "font-bold text-gray-800" }, item.n), 
                                React.createElement("div", { className: "text-xs text-gray-500 mt-1" },
                                    item.noodle && React.createElement("span", {className:"mr-2"}, item.noodle),
                                    item.spice && React.createElement("span", {className:"mr-2"}, item.spice),
                                    item.combo > 0 && React.createElement("span", {className:"block text-[#B91C1C]"}, `+${comboOptions.find(c=>c.id===item.combo).n} (${item.drink})`)
                                ),
                                React.createElement("p", { className: "text-sm font-bold text-[#B91C1C] mt-1" }, `$${item.unitPrice}`)
                            ),
                            React.createElement("button", { onClick: () => removeFromCart(item.cartId), className: "text-gray-400 p-2" }, React.createElement(Icon, {name:"trash", className:"w-4 h-4"}))
                        ))
                    ),
                    React.createElement("div", { className: "p-4 border-t border-gray-100 bg-gray-50 pb-safe" },
                        React.createElement("div", { className: "flex justify-between items-center mb-4" },
                            React.createElement("span", { className: "text-gray-600 font-bold" }, "ç¸½é‡‘é¡"),
                            React.createElement("div", { className: "text-right" },
                                React.createElement("span", { className: `font-bold text-2xl ${total < requiredTotal ? 'text-red-500' : 'text-[#B91C1C]'}` }, `$${total}`),
                                total < requiredTotal && React.createElement("p", { className: "text-xs text-red-500 font-bold" }, `(æœªé”ä½æ¶ˆï¼Œå·®$${requiredTotal - total})`)
                            )
                        ),
                        React.createElement("button", { onClick: handleSubmit, className: `w-full py-4 rounded-xl font-bold text-white text-lg shadow-lg transition-all ${total < requiredTotal ? 'bg-gray-400 cursor-not-allowed' : 'bg-[#B91C1C] shadow-red-200 active:scale-95'}` }, "ç¢ºèªé å…ˆé»é¤")
                    )
                )
            )
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
  </script>
</head>
<body>
  <div id="root"></div>
</body>
</html>