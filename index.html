<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è–©è«¾ç“¦è¨‚ä½ç³»çµ±</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root {
      --brand-main: #B91C1C;
      --brand-light: #FEF2F2;
      --brand-accent: #EF4444;
      --bg-color: #f8fafc;
    }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", Roboto, sans-serif; 
      background-color: var(--bg-color); 
      margin: 0; padding: 0; overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-slide-up { animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    .input-field { 
      @apply w-full p-4 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-[#B91C1C] focus:border-transparent outline-none transition-all text-base; 
    }
    .label-text { 
      @apply text-xs font-bold text-gray-500 mb-2 block uppercase tracking-wider ml-1; 
    }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>

  <script type="module">
    import React, { useState, useEffect, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
    import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';

    const LIFF_ID = "2008861231-EA0Hpl68"; 
    // Updated display name variable, though mostly used in header now
    const RESTAURANT_NAME = "è–©è«¾ç“¦ç¾©å¼å»šæˆ¿"; 
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxHOJOzIGqCnW-ttjB0_OeJ6eIz3iqF3dnYSwGeK4L2vRi6dEuWZ-i_DoM5pHjz9u7PlA/exec";

    const runGAS = async (action, params = {}) => {
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action, ...params })
        });
        return await response.json();
      } catch (err) {
        return { status: 'error', message: 'é€£ç·šå¤±æ•—' };
      }
    };

    const Icon = ({ name, className }) => {
      const paths = {
        menu: "M4 6h16M4 12h16M4 18h16",
        calendar: "M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2-2H5a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z",
        map: "M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z",
        user: "M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z",
        gift: "M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7",
        back: "M10 19l-7-7m0 0l7-7m-7 7h18",
        phone: "M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z",
        star: "M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z",
        download: "M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4",
        close: "M6 18L18 6M6 6l12 12",
        trash: "M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16",
        edit: "M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z",
        cart: "M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z",
        question: "M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4 0 .742-.215 1.42-.588 2H12v2h3.535a4.004 4.004 0 01-7.07 0H5V9h3.228zM12 4a8 8 0 100 16 8 8 0 000-16z",
        info: "M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z",
        ticket: "M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z",
        history: "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z",
        stamp: "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z",
        search: "M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z",
        chevronDown: "M19 9l-7 7-7-7",
        share: "M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z",
        qr: "M12 4v1m6 11h2m-6 0h-2v4h2v-4zm-6 2v6h6v-6h-6zm2 2h2v2H8v-2zm12-2v2h2v-2h-2zm-2-2v2h2v-2h-2zm2-2v2h2v-2h-2zm-2-2v2h2v-2h-2zm2-2v2h2v-2h-2zm-6 0h-6v6h6v-6zm-2 2H8v2h2v-2zm6-8h-6v6h6v-6zm-2 2h-2v2h2v-2z",
        check: "M5 13l4 4L19 7"
      };
      return React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", className, fill: "none", viewBox: "0 0 24 24", stroke: "currentColor", strokeWidth: "2" },
        React.createElement("path", { strokeLinecap: "round", strokeLinejoin: "round", d: paths[name] || "" })
      );
    };

    // Components Definitions
    const HomeView = ({ setView, profile, data }) => {
      const handleNavClick = (id) => {
        if (id === 'BOOKING' && !data.member) {
          Swal.fire({
            title: 'éæœƒå“¡ç„¡æ³•ç·šä¸Šè¨‚ä½',
            text: 'è«‹å…ˆå®Œæˆè¨»å†Šæˆç‚ºæœƒå“¡ï¼Œæ–¹å¯ä½¿ç”¨ç·šä¸Šè¨‚ä½æœå‹™ã€‚',
            icon: 'warning',
            confirmButtonText: 'å‰å¾€è¨»å†Š',
            confirmButtonColor: '#B91C1C',
            showCancelButton: true,
            cancelButtonText: 'å–æ¶ˆ'
          }).then((result) => {
            if (result.isConfirmed) {
                setView('MEMBER'); 
            }
          });
          return;
        }
        setView(id);
      };

      return React.createElement("div", { className: "flex flex-col h-full bg-[#f8fafc]" },
        React.createElement("div", { className: "bg-white p-6 sticky top-0 z-10 flex justify-between items-start shadow-sm shrink-0" },
          React.createElement("div", null,
             React.createElement("h1", { className: "font-black text-gray-900 text-2xl tracking-wide leading-tight" }, RESTAURANT_NAME), 
             React.createElement("p", { className: "text-sm text-gray-500 font-medium mt-1" }, 
                profile?.displayName ? `${profile.displayName}, æ‚¨å¥½` : "Welcome"
             )
          ),
          profile && React.createElement("img", { src: profile.pictureUrl, className: "w-12 h-12 rounded-full border-2 border-gray-100 shadow-sm" })
        ),
        React.createElement("div", { className: "flex-1 overflow-y-auto p-5 space-y-6" },
          React.createElement("div", { className: "relative h-56 rounded-3xl overflow-hidden shadow-2xl transform transition-all hover:scale-[1.01]" },
            React.createElement("img", { src: "https://i.ibb.co/qLFg7gSk/Gemini-Generated-Image-cmj4yzcmj4yzcmj4.png", className: "w-full h-full object-cover" }),
            React.createElement("div", { className: "absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent flex items-end p-6 text-white" },
              React.createElement("div", null,
                React.createElement("h3", { className: "font-bold text-2xl drop-shadow-md" }, "ç¾©å¼é¢¨å‘³ï¼Œç”¨å¿ƒå‘ˆç¾"),
                React.createElement("p", { className: "text-xs opacity-90 uppercase tracking-widest font-bold mt-1" }, "AUTHENTIC ITALIAN CUISINE")
              )
            )
          ),
          React.createElement("div", { className: "grid grid-cols-2 gap-4" },
            [
              { id: 'MENU', name: 'ç²¾ç·»èœå–®', icon: 'menu', from: 'from-orange-50', to: 'to-white', text: 'text-orange-600' },
              { id: 'BOOKING', name: 'ç·šä¸Šè¨‚ä½', icon: 'calendar', from: 'from-red-50', to: 'to-white', text: 'text-[#B91C1C]' },
              { id: 'MEMBER', name: 'æœƒå“¡ä¸­å¿ƒ', icon: 'user', from: 'from-pink-50', to: 'to-white', text: 'text-pink-600' },
              { id: 'NEWS', name: 'æ´»å‹•å„ªæƒ ', icon: 'gift', from: 'from-yellow-50', to: 'to-white', text: 'text-yellow-600' },
              { id: 'LOCATION', name: 'åº—å®¶è³‡è¨Š', icon: 'map', from: 'from-blue-50', to: 'to-white', text: 'text-blue-500' },
              { id: 'FAQ', name: 'å¸¸è¦‹å•é¡Œ', icon: 'question', from: 'from-gray-100', to: 'to-white', text: 'text-gray-600' }
            ].map(btn => (
              React.createElement("button", { key: btn.id, onClick: () => handleNavClick(btn.id), className: `h-36 bg-gradient-to-br ${btn.from} ${btn.to} rounded-3xl shadow-sm border border-white/50 flex flex-col items-center justify-center gap-3 active:scale-95 transition-all relative group hover:shadow-lg` },
                React.createElement("div", { className: `w-14 h-14 bg-white rounded-full flex items-center justify-center ${btn.text} shadow-md group-hover:scale-110 transition-transform`}, React.createElement(Icon, { name: btn.icon, className: "w-7 h-7" })),
                React.createElement("span", { className: "font-bold text-gray-700 text-base" }, btn.name)
              )
            ))
          ),
          React.createElement("p", { className: "text-center text-xs text-gray-300 py-4" }, "Â© 2024 Sanova Italian Kitchen")
        )
      )
    );
    };

    const MenuView = ({ chefRecommendations }) => {
        const [modalItem, setModalItem] = useState(null);
        const [dishModal, setDishModal] = useState(null);
        // Default to FULL menu
        const [tab, setTab] = useState('FULL');
        const dishes = (chefRecommendations && chefRecommendations.length > 0) ? chefRecommendations : [];
        const menuItems = [
            { src: "https://i.ibb.co/XZQx4dWc/S-36053013-0.jpg", full: "https://i.ibb.co/TDV3qsnx/2025-page-0001.jpg", label: "èœå–®æ­£é¢", filename: "sanova-menu-front.webp" },
            { src: "https://i.ibb.co/dsdPtQKN/S-36053012-0.jpg", full: "https://i.ibb.co/dCKyZ74/2025-page-0002.jpg", label: "èœå–®èƒŒé¢", filename: "sanova-menu-back.webp" }
        ];

        return React.createElement(React.Fragment, null,
            React.createElement("div", { className: "flex sticky top-0 bg-white z-10 shadow-sm" },
                // Swapped order: FULL first, FEATURED second
                React.createElement("button", { onClick: () => setTab('FULL'), className: `flex-1 py-3 font-bold text-sm border-b-2 transition-colors ${tab === 'FULL' ? 'border-[#B91C1C] text-[#B91C1C]' : 'border-transparent text-gray-500'}`}, "å®Œæ•´èœå–®"),
                React.createElement("button", { onClick: () => setTab('FEATURED'), className: `flex-1 py-3 font-bold text-sm border-b-2 transition-colors ${tab === 'FEATURED' ? 'border-[#B91C1C] text-[#B91C1C]' : 'border-transparent text-gray-500'}`}, "ä¸»å»šæ¨è–¦")
            ),
            React.createElement("div", { className: "p-6 space-y-8" },
                tab === 'FEATURED' ? 
                React.createElement("div", { className: "space-y-4 animate-fade-in" },
                    dishes.length === 0 ? React.createElement("p", {className: "text-center text-gray-400"}, "ç›®å‰æ²’æœ‰ä¸»å»šæ¨è–¦é …ç›®ã€‚") :
                    dishes.map((d, i) => React.createElement("div", { key: i, onClick: () => setDishModal(d), className: "bg-white rounded-xl shadow-md overflow-hidden border border-gray-100 flex cursor-pointer hover:shadow-lg transition-shadow" },
                        React.createElement("img", { src: d['åœ–ç‰‡ç¶²å€'], className: "w-28 h-28 object-cover shrink-0" }),
                        React.createElement("div", { className: "p-3 flex flex-col justify-center flex-1" },
                             React.createElement("h4", { className: "font-bold text-gray-800" }, d['ç”¢å“åç¨±']),
                             React.createElement("p", { className: "text-xs text-gray-500 mt-1 line-clamp-2" }, d['ç”¢å“èªªæ˜']),
                             React.createElement("p", { className: "text-[#B91C1C] font-bold mt-2" }, `$${d['ç”¢å“åƒ¹æ ¼']}`)
                        )
                    ))
                ) :
                // Full Menu View
                React.createElement("div", { className: "space-y-6 animate-fade-in" },
                    menuItems.map(item =>
                        React.createElement("div", { key: item.src, className: "text-center" },
                            React.createElement("p", { className: "font-bold text-gray-600 mb-2 text-sm" }, item.label),
                            React.createElement("img", {
                                src: item.src,
                                className: "w-full rounded-lg shadow-lg cursor-pointer transition-transform hover:scale-105 duration-300",
                                onClick: () => setModalItem(item)
                            })
                        )
                    )
                )
            ),
            modalItem && React.createElement("div", {
                    className: "fixed inset-0 bg-black/80 flex flex-col items-center justify-center z-50 animate-fade-in p-4",
                    onClick: () => setModalItem(null)
                },
                React.createElement("button", {
                    className: "absolute top-5 right-5 bg-white/20 backdrop-blur-sm text-white rounded-full p-2 hover:bg-white/30 transition-all z-20",
                    onClick: () => setModalItem(null)
                }, React.createElement(Icon, { name: "close", className: "w-7 h-7" })),
                React.createElement("div", {
                        className: "flex flex-col items-center",
                        onClick: e => e.stopPropagation()
                    },
                    React.createElement("img", {
                        src: modalItem.full,
                        className: "max-w-full max-h-[75vh] rounded-lg shadow-2xl object-contain"
                    }),
                    React.createElement("a", {
                        href: modalItem.full,
                        download: modalItem.filename,
                        className: "mt-4 inline-flex items-center justify-center gap-2 bg-[#B91C1C] text-white px-5 py-3 rounded-lg text-sm font-bold shadow-md hover:bg-opacity-90 transition-all"
                    }, React.createElement(Icon, { name: "download", className: "w-5 h-5" }), "ä¸‹è¼‰èœå–®")
                )
            ),
            dishModal && React.createElement("div", {
                className: "fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in",
                onClick: () => setDishModal(null)
            },
                React.createElement("div", { 
                    className: "bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl animate-slide-up",
                    onClick: e => e.stopPropagation() 
                },
                    React.createElement("div", { className: "relative h-64" },
                        React.createElement("img", { src: dishModal['åœ–ç‰‡ç¶²å€'], className: "w-full h-full object-cover" }),
                        React.createElement("button", { 
                            onClick: () => setDishModal(null),
                            className: "absolute top-3 right-3 bg-black/30 text-white p-1 rounded-full backdrop-blur-md hover:bg-black/50 transition-colors"
                        }, React.createElement(Icon, {name:"close", className:"w-6 h-6"}))
                    ),
                    React.createElement("div", { className: "p-6" },
                        React.createElement("div", { className: "flex justify-between items-start mb-2" },
                             React.createElement("h3", { className: "text-2xl font-bold text-gray-800" }, dishModal['ç”¢å“åç¨±']),
                             React.createElement("span", { className: "text-xl font-bold text-[#B91C1C]" }, `$${dishModal['ç”¢å“åƒ¹æ ¼']}`)
                        ),
                        React.createElement("div", { className: "h-px bg-gray-100 my-4" }),
                        React.createElement("p", { className: "text-gray-600 leading-relaxed text-sm" }, dishModal['ç”¢å“èªªæ˜']),
                        React.createElement("button", {
                            onClick: () => setDishModal(null),
                            className: "w-full mt-6 bg-[#B91C1C] text-white py-3 rounded-xl font-bold shadow-lg shadow-red-200 active:scale-95 transition-transform"
                        }, "é—œé–‰")
                    )
                )
            )
        );
    };

    const LocationView = ({ profile }) => {
        return React.createElement("div", { className: "p-6 space-y-6 pb-24" },
            React.createElement("iframe", { 
                src: "https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3637.373403565137!2d118.42103517593254!3d24.43813957833075!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x34152b1b31278881%3A0xb355205561237a3!2z6JOu6K2v55m-576p5byD55m-5a625Yqq5aSn5Yip6aSQ5bqr!5e0!3m2!1szh-TW!2stw!4v1709400000000!5m2!1szh-TW!2stw", 
                className: "w-full h-64 rounded-xl border-0 shadow-md", allowFullScreen: "", loading: "lazy", referrerPolicy: "no-referrer-when-downgrade" 
            }),
            React.createElement("div", { className: "space-y-4" },
                React.createElement("div", { className: "flex gap-4 items-start" }, React.createElement(Icon, { name: "map", className: "w-6 h-6 text-[#B91C1C] shrink-0 mt-1" }), React.createElement("div", null, React.createElement("h4", { className: "font-bold" }, "é¤å»³åœ°å€"), React.createElement("p", { className: "text-gray-600" }, "é‡‘é–€ç¸£é‡‘æ¹–é®å¤ªæ¹–è·¯äºŒæ®µ3å··6è™Ÿ"))),
                React.createElement("div", { className: "flex gap-4 items-start" }, React.createElement(Icon, { name: "phone", className: "w-6 h-6 text-[#B91C1C] shrink-0 mt-1" }), React.createElement("div", null, React.createElement("h4", { className: "font-bold" }, "è¯çµ¡é›»è©±"), React.createElement("p", { className: "text-gray-600" }, "082-332530")))
            ),
             React.createElement("div", { className: "bg-blue-50 p-4 rounded-xl border border-blue-200" },
                React.createElement("h4", { className: "font-bold text-gray-800 mb-2" }, "äº¤é€šè³‡è¨Š"),
                React.createElement("p", { className: "text-sm text-gray-600" }, "ğŸš— é™„è¿‘æœ‰æ˜‡æ†æ˜Œåœ°ä¸‹åœè»Šå ´ï¼Œæ­¥è¡Œç´„2åˆ†é˜ã€‚"),
                React.createElement("p", { className: "text-sm text-gray-600 mt-1" }, "ğŸšŒ å¯æ­ä¹˜å…¬è»Šè‡³ã€Œå¤ªæ¹–ç«™ã€ï¼Œæ­¥è¡Œç´„3åˆ†é˜ã€‚")
            ),
            React.createElement("a", { href: "tel:082-332530", className: "fixed bottom-6 left-6 right-6 z-20 bg-[#B91C1C] text-white py-4 rounded-xl font-bold shadow-xl shadow-red-200 flex justify-center items-center gap-2 transition-all active:scale-95" },
                React.createElement(Icon, { name: "phone", className: "w-5 h-5" }),
                "æ’¥æ‰“è¨‚ä½å°ˆç·š"
            )
        );
    };

    const NewsView = ({ promotions }) => {
        const [filter, setFilter] = useState('ALL');
        const filtered = filter === 'ALL' ? promotions : promotions.filter(p => p['é¡å‹'] === filter);
        return React.createElement("div", { className: "flex flex-col h-full" },
             React.createElement("div", { className: "flex p-4 gap-2 overflow-x-auto no-scrollbar bg-white shadow-sm sticky top-0 z-10" },
                ['ALL', 'æ´»å‹•', 'å„ªæƒ '].map(t => React.createElement("button", { key: t, onClick: () => setFilter(t), className: `px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${filter === t ? 'bg-[#B91C1C] text-white' : 'bg-gray-100 text-gray-600'}` }, t === 'ALL' ? 'å…¨éƒ¨' : t))
             ),
             React.createElement("div", { className: "p-4 space-y-4 flex-1 overflow-y-auto" },
                !filtered || filtered.length === 0 ? React.createElement("p", {className: "text-center text-gray-500 mt-8"}, "ç›®å‰æ²’æœ‰ç›¸é—œå…§å®¹ã€‚") :
                filtered.map((p, i) => React.createElement("div", { key: i, className: "bg-white rounded-xl shadow-md border overflow-hidden" },
                    p['åœ–ç‰‡ç¶²å€'] && React.createElement("img", { src: p['åœ–ç‰‡ç¶²å€'], className: "w-full h-44 object-cover" }),
                    React.createElement("div", { className: "p-4" },
                        p['é¡å‹'] === 'æ´»å‹•' && React.createElement("div", { className: "text-sm text-red-600 font-bold mb-1 flex items-center gap-1" }, React.createElement(Icon, {name:"calendar", className:"w-4 h-4"}), `æ´»å‹•æ—¥æœŸï¼š${new Date(p['æ´»å‹•æ—¥æœŸ']).toLocaleDateString()}`),
                        React.createElement("h3", { className: "font-bold text-[#B91C1C]" }, p['æ¨™é¡Œ']),
                        React.createElement("p", { className: "text-sm text-gray-500 mt-1" }, p['å…§å®¹']),
                         p['é¡å‹'] === 'å„ªæƒ ' && React.createElement("button", { onClick: () => Swal.fire('å·²é ˜å–', 'å„ªæƒ åˆ¸å·²å­˜å…¥æ‚¨çš„ç¥¨å¤¾', 'success'), className: "mt-3 w-full border border-[#B91C1C] text-[#B91C1C] py-2 rounded-lg text-sm font-bold hover:bg-red-50" }, "é ˜å–å„ªæƒ åˆ¸")
                    )
                ))
            )
        );
    };

    const FaqView = ({ faqs }) => (
        React.createElement("div", { className: "p-4 space-y-3" },
          !faqs || faqs.length === 0 ? React.createElement("p", {className: "text-center text-gray-500 mt-8"}, "ç›®å‰æ²’æœ‰å¸¸è¦‹å•é¡Œã€‚") :
          faqs.map((f, i) => React.createElement("details", { key: i, className: "bg-gray-50 rounded-xl border p-4 group" }, 
            React.createElement("summary", { className: "font-bold cursor-pointer flex justify-between items-center" }, f.å•é¡Œ, React.createElement(Icon, { name: "back", className: "w-4 h-4 -rotate-90 group-open:rotate-90 transition-transform" })), 
            React.createElement("p", { className: "text-sm text-gray-600 mt-2 pt-2 border-t" }, f.å›ç­”)
          ))
        )
    );

    const BookingView = ({ member, profile, data, setData, onBack, onBookingSuccess }) => {
        const [mode, setMode] = useState('CREATE');
        const today = new Date();
        const [viewMonth, setViewMonth] = useState(today.toISOString().slice(0, 7));
        const [form, setForm] = useState({ 
            date: '', 
            time: '', adults: 2, children: 0, highChairs: 0, 
            name: member?.name || profile?.displayName || '', 
            phone: member?.phone || '', notes: '', vegetarian: false, 
            bookingId: null, preOrder: ''
        });
        
        const [searchForm, setSearchForm] = useState(() => {
            if (member && member.é›»è©±) {
                return { name: member.å§“å || '', phone: member.é›»è©±.replace(/'/g, '') };
            }
            try {
                const saved = localStorage.getItem('booking_search_info');
                if (saved) return JSON.parse(saved);
            } catch(e) {}
            return { name: member?.name || profile?.displayName || '', phone: '' };
        });

        useEffect(() => {
            if (member && member.é›»è©±) {
                setSearchForm(prev => ({ 
                    ...prev, 
                    phone: member.é›»è©±.replace(/'/g, ''),
                    name: member.å§“å || prev.name
                }));
            }
        }, [member]);

        const [searchResults, setSearchResults] = useState([]);
        const [submitting, setSubmitting] = useState(false);
        const slotSettings = data.slotSettings || {};

        const daysInMonth = useMemo(() => {
            const [y, m] = viewMonth.split('-').map(Number);
            const dates = [];
            const days = new Date(y, m, 0).getDate();
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0,0,0,0);

            for(let i = 1; i <= days; i++) {
                const d = new Date(y, m - 1, i);
                if (d >= tomorrow && d.getDay() !== 1) { 
                     dates.push(d);
                }
            }
            return dates;
        }, [viewMonth]);

        useEffect(() => {
            localStorage.setItem('booking_search_info', JSON.stringify(searchForm));
        }, [searchForm]);

        const getSlotInfo = (time) => {
            const defaultMax = slotSettings[time] ? slotSettings[time].max : 30;
            if (form.date && data.seatInventory) {
                const inventory = data.seatInventory.find(item => item['æ—¥æœŸ'] === form.date && item['æ™‚æ®µ'].startsWith(time));
                if (inventory) {
                    return { 
                        max: Number(inventory['å¯è¨‚ä½äººæ•¸']), 
                        booked: Number(inventory['å·²è¨‚ä½äººæ•¸']), 
                        remaining: Number(inventory['å‰©é¤˜ç©ºä½']) 
                    };
                }
            }
            return { max: defaultMax, booked: 0, remaining: defaultMax };
        };

        const totalPeople = form.adults + form.children;
        const lunchSlots = ["11:00", "11:30", "12:00", "12:30", "13:00"];
        const dinnerSlots = ["17:00", "17:30", "18:00", "18:30", "19:00", "19:30"];

        const sendLineMessage = async (text) => {
            if (window.liff.isInClient()) {
                await window.liff.sendMessages([{ type: 'text', text: text }]).catch(err => console.error("Line msg error:", err));
            }
        };

        const handleBooking = async e => {
            e.preventDefault();
            if (!form.date) {
                Swal.fire({ icon: 'warning', title: 'è«‹é¸æ“‡æ—¥æœŸ', text: 'è«‹é»é¸è¡Œäº‹æ›†ä¸Šçš„æ—¥æœŸ', confirmButtonColor: '#D32F2F' });
                return;
            }
            if (!form.time) {
                Swal.fire({ icon: 'warning', title: 'è«‹é¸æ“‡æ™‚é–“', text: 'è«‹é»é¸ä¸‹æ–¹çš„ç”¨é¤æ™‚æ®µ', confirmButtonColor: '#D32F2F' });
                return;
            }
            const phoneRegex = /^09\d{8}$/;
            if (!phoneRegex.test(form.phone)) {
                Swal.fire({ icon: 'error', title: 'é›»è©±è™Ÿç¢¼æ ¼å¼éŒ¯èª¤', text: 'è«‹è¼¸å…¥æœ‰æ•ˆçš„ 10 ä½æ‰‹æ©Ÿè™Ÿç¢¼ï¼Œå¿…é ˆä»¥ 09 é–‹é ­ã€‚', confirmButtonColor: '#D32F2F' });
                return;
            }
            
            setSubmitting(true);
            const action = mode === 'EDIT' ? 'updateBooking' : 'booking';
            const res = await runGAS(action, { ...form, lineUserId: profile?.userId });
            
            if (res.status === 'success') {
                // Optimistic UI Update for Inventory
                const updatedInventory = data.seatInventory ? [...data.seatInventory] : [];
                const targetIndex = updatedInventory.findIndex(i => i['æ—¥æœŸ'] === form.date && i['æ™‚æ®µ'].startsWith(form.time));
                const peopleCount = form.adults + form.children;
                
                if (targetIndex >= 0) {
                    updatedInventory[targetIndex]['å·²è¨‚ä½äººæ•¸'] = Number(updatedInventory[targetIndex]['å·²è¨‚ä½äººæ•¸']) + peopleCount;
                    updatedInventory[targetIndex]['å‰©é¤˜ç©ºä½'] = Number(updatedInventory[targetIndex]['å‰©é¤˜ç©ºä½']) - peopleCount;
                } else {
                    updatedInventory.push({ 
                        'æ—¥æœŸ': form.date, 
                        'æ™‚æ®µ': form.time, 
                        'å¯è¨‚ä½äººæ•¸': 30, 
                        'å·²è¨‚ä½äººæ•¸': peopleCount, 
                        'å‰©é¤˜ç©ºä½': 30 - peopleCount 
                    });
                }
                setData(prev => ({ ...prev, seatInventory: updatedInventory }));

                const bookingCode = res.bookingCode || 'æŸ¥è©¢ä¸­';
                const msg = mode === 'EDIT' 
                    ? `ğŸ“ è–©è«¾ç“¦è¨‚ä½ä¿®æ”¹ç¢ºèªï¼š\nè¨‚ä½ä»£è™Ÿï¼š${bookingCode}\næ—¥æœŸï¼š${form.date}\næ™‚é–“ï¼š${form.time}\näººæ•¸ï¼š${form.adults}å¤§${form.children}å°\nå§“åï¼š${form.name}\né›»è©±ï¼š${form.phone}\næ‚¨çš„è¨‚ä½å·²æ›´æ–°ï¼`
                    : `ğŸ”” è–©è«¾ç“¦è¨‚ä½ç¢ºèªï¼š\nè¨‚ä½ä»£è™Ÿï¼š${bookingCode}\næ—¥æœŸï¼š${form.date}\næ™‚é–“ï¼š${form.time}\näººæ•¸ï¼š${form.adults}å¤§${form.children}å°\nå§“åï¼š${form.name}\né›»è©±ï¼š${form.phone}\næˆ‘å€‘æœƒç›¡å¿«ç‚ºæ‚¨ç¢ºèªä½ç½®ï¼`;
                
                Swal.fire({
                    title: mode === 'EDIT' ? 'ä¿®æ”¹æˆåŠŸï¼' : 'é ç´„æˆåŠŸï¼',
                    html: `è¨‚ä½ä»£è™Ÿï¼š<b>${bookingCode}</b><br>å·²ç™¼é€è¨Šæ¯è‡³å®˜æ–¹å¸³è™Ÿã€‚<br><br><b>è«‹å•éœ€è¦${mode === 'EDIT' ? 'ä¿®æ”¹' : ''}é å…ˆé»é¤å—ï¼Ÿ</b>`,
                    icon: 'success',
                    showCancelButton: true,
                    confirmButtonText: 'å‰å¾€é»é¤',
                    cancelButtonText: 'å®Œæˆ',
                    confirmButtonColor: '#B91C1C',
                    cancelButtonColor: '#6e7881',
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        onBookingSuccess({
                            bookingId: res.bookingId, 
                            adults: form.adults, 
                            children: form.children, 
                            preOrder: form.preOrder,
                            bookingMessageText: msg 
                        });
                    } else {
                        await sendLineMessage(msg);
                        onBack();
                    }
                });
            } else {
                Swal.fire({ icon: 'error', title: 'å¤±æ•—', text: res.message, confirmButtonColor: '#D32F2F' });
            }
            setSubmitting(false);
        };

        const handleQuickCancel = async (bookingId, info) => {
            Swal.fire({
                title: 'ç¢ºå®šå–æ¶ˆè¨‚ä½?',
                text: `${info.date} ${info.time} çš„è¨‚ä½å°‡è¢«å–æ¶ˆä¸”ç„¡æ³•å¾©åŸã€‚`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#D32F2F',
                confirmButtonText: 'ç¢ºèªå–æ¶ˆ',
                cancelButtonText: 'ä¿ç•™'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    setSubmitting(true);
                    const res = await runGAS('cancelBooking', { bookingId: bookingId, date: info.date, time: info.time, adults: info.adults, children: info.children });
                    setSubmitting(false);
                    if (res.status === 'success') {
                        await sendLineMessage(`âŒ è–©è«¾ç“¦è¨‚ä½å–æ¶ˆï¼š\nè¨‚ä½ä»£è™Ÿï¼š${info.bookingCode}\næ—¥æœŸï¼š${info.date}\næ™‚é–“ï¼š${info.time}\nå§“åï¼š${info.name}\né›»è©±ï¼š${info.phone}\næ‚¨çš„è¨‚ä½å·²å–æ¶ˆã€‚`);
                        Swal.fire('å·²å–æ¶ˆ', 'æ‚¨çš„è¨‚ä½å·²æˆåŠŸå–æ¶ˆã€‚', 'success');
                        handleSearch(new Event('submit'));
                    } else {
                        Swal.fire({ icon: 'error', title: 'å–æ¶ˆå¤±æ•—', text: res.message });
                    }
                }
            });
        };

        const handleCancel = async () => { 
             handleQuickCancel(form.bookingId, form);
        };

        const handleSearch = async (e) => {
            if(e) e.preventDefault();
            setSubmitting(true);
            const res = await runGAS('findBooking', searchForm);
            setSubmitting(false);
            if (res.status === 'success' && res.bookings.length > 0) {
                setSearchResults(res.bookings);
            } else {
                setSearchResults([]);
                Swal.fire({ icon: 'info', title: 'æŸ¥ç„¡è³‡æ–™', text: 'æ‰¾ä¸åˆ°ç¬¦åˆçš„æœªä¾†è¨‚ä½ç´€éŒ„ã€‚' });
            }
        };

        const handleEditClick = (booking) => {
            setForm({
                date: booking.date, time: booking.time, adults: booking.adults, children: booking.children, highChairs: booking.highChairs,
                name: booking.name, phone: booking.phone, notes: booking.notes, vegetarian: booking.vegetarian,
                bookingId: booking.id, preOrder: booking.preOrder
            });
            setViewMonth(booking.date.slice(0, 7));
            setMode('EDIT');
        };

        const NumberInput = ({ label, value, onChange, min = 0, max = 99, disabled = false }) => {
            const handleChange = (delta) => {
                const newValue = value + delta;
                if (newValue >= min && newValue <= max) onChange(newValue);
            };
            return React.createElement("div", { className: "flex-1 text-center" },
                React.createElement("span", { className: "label-text text-center block" }, label),
                React.createElement("div", { className: "flex items-center justify-center gap-3 mt-1" },
                    React.createElement("button", { type: "button", onClick: () => handleChange(-1), disabled: disabled || value <= min, className: "w-8 h-8 rounded-full bg-gray-100 text-gray-600 text-lg font-bold disabled:opacity-30 hover:bg-gray-200 transition-colors" }, "-"),
                    React.createElement("span", { className: "text-lg font-bold w-6 text-center text-gray-800" }, value),
                    React.createElement("button", { type: "button", onClick: () => handleChange(1), disabled: disabled || value >= max, className: "w-8 h-8 rounded-full bg-gray-100 text-gray-600 text-lg font-bold disabled:opacity-30 hover:bg-gray-200 transition-colors" }, "+")
                )
            );
        };

        const DateCard = ({ date, isSelected, onSelect }) => {
            const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            return React.createElement("div", { 
                onClick: onSelect,
                className: `flex-shrink-0 w-16 h-20 rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all border ${isSelected ? 'bg-[#B91C1C] text-white border-[#B91C1C] shadow-md transform scale-105' : 'bg-white text-gray-600 border-gray-200'}` 
            },
                React.createElement("span", { className: "text-xs font-bold mb-1" }, dayNames[date.getDay()]),
                React.createElement("span", { className: "text-xl font-bold" }, date.getDate())
            );
        };

        const TimeSlotButton = ({ time }) => {
            const { remaining } = getSlotInfo(time);
            const isFull = remaining < totalPeople;
            const isSelected = form.time === time;
            
            return React.createElement("button", {
                type: "button",
                onClick: () => !isFull && setForm({...form, time}),
                disabled: isFull,
                className: `relative px-3 py-3 rounded-lg text-sm font-bold border transition-all flex flex-col items-center justify-center ${
                    isFull ? 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed' :
                    isSelected ? 'bg-[#B91C1C] text-white border-[#B91C1C] shadow-md' :
                    'bg-white text-gray-700 border-gray-200 hover:border-[#B91C1C]'
                }`
            }, 
                React.createElement("span", null, time),
                React.createElement("span", {className: `text-[10px] font-normal mt-0.5 ${isFull ? 'text-gray-400' : isSelected ? 'text-red-100' : 'text-gray-500'}`}, 
                    isFull ? "å®¢æ»¿" : `å‰©${remaining}ä½`
                )
            );
        };

        if (mode === 'SEARCH') {
             return React.createElement("div", { className: "p-6 space-y-6" },
                React.createElement("div", { className: "flex gap-2 mb-4" },
                    React.createElement("button", { onClick: () => setMode('CREATE'), className: "flex-1 py-2 text-center text-gray-500 font-bold bg-gray-100 rounded-lg" }, "æˆ‘è¦è¨‚ä½"),
                    React.createElement("button", { className: "flex-1 py-2 text-center text-white font-bold bg-[#B91C1C] rounded-lg shadow" }, "æŸ¥è©¢/ä¿®æ”¹/å–æ¶ˆ")
                ),
                React.createElement("form", { onSubmit: handleSearch, className: "bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-4" },
                    React.createElement("h3", { className: "font-bold text-gray-700" }, "æŸ¥è©¢è¨‚ä½ç´€éŒ„"),
                    React.createElement("input", { placeholder: "è¨‚ä½å§“å", className: "input-field", value: searchForm.name, onChange: e => setSearchForm({...searchForm, name: e.target.value}) }),
                    React.createElement("input", { placeholder: "è¨‚ä½é›»è©±", type: "tel", className: "input-field", value: searchForm.phone, onChange: e => setSearchForm({...searchForm, phone: e.target.value}) }),
                    React.createElement("button", { disabled: submitting, className: "w-full bg-[#B91C1C] text-white py-3 rounded-xl font-bold" }, submitting ? "æŸ¥è©¢ä¸­..." : "æŸ¥è©¢")
                ),
                searchResults.length > 0 && React.createElement("div", { className: "space-y-4" },
                    searchResults.map(res => React.createElement("div", { key: res.id, className: "bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col gap-3" },
                        React.createElement("div", null,
                            React.createElement("div", { className: "flex justify-between items-center" },
                                React.createElement("p", { className: "font-bold text-lg" }, `${res.date} ${res.time}`),
                                React.createElement("span", { className: "text-xs font-mono bg-gray-100 px-2 py-1 rounded" }, res.bookingCode)
                            ),
                            React.createElement("p", { className: "text-sm text-gray-600" }, `${res.adults}å¤§ ${res.children}å°`),
                            res.preOrder && React.createElement("p", { className: "text-xs text-[#B91C1C] mt-1" }, `å·²é»é¤: ${res.preOrder}`)
                        ),
                        React.createElement("div", { className: "grid grid-cols-3 gap-2" },
                            React.createElement("button", { onClick: () => handleEditClick(res), className: "bg-gray-100 text-gray-600 py-2 rounded-lg text-xs font-bold" }, "ä¿®æ”¹è³‡æ–™"),
                            React.createElement("button", { onClick: () => onBookingSuccess({bookingId: res.id, adults: res.adults, children: res.children, preOrder: res.preOrder}), className: "bg-blue-50 text-blue-700 py-2 rounded-lg text-xs font-bold" }, "ä¿®æ”¹é¤é»"),
                            React.createElement("button", { onClick: () => handleQuickCancel(res.id, res), className: "bg-red-50 text-[#B91C1C] py-2 rounded-lg text-xs font-bold" }, "å–æ¶ˆè¨‚ä½")
                        )
                    ))
                )
             );
        }

        return React.createElement("form", { onSubmit: handleBooking, className: "p-6 space-y-6 pb-24" },
             mode !== 'EDIT' && React.createElement("div", { className: "flex flex-col gap-4 mb-2" },
                React.createElement("div", { className: "flex gap-2" },
                   React.createElement("button", { className: "flex-1 py-2 text-center text-white font-bold bg-[#B91C1C] rounded-lg shadow" }, "æˆ‘è¦è¨‚ä½"),
                   React.createElement("button", { type: "button", onClick: () => setMode('SEARCH'), className: "flex-1 py-2 text-center text-gray-500 font-bold bg-gray-100 rounded-lg" }, "æŸ¥è©¢/ä¿®æ”¹/å–æ¶ˆ")
                )
            ),
            mode === 'EDIT' && React.createElement("div", { className: "bg-yellow-50 p-3 rounded-lg border border-yellow-200 text-yellow-800 text-center font-bold mb-2" }, 
                `æ­£åœ¨ä¿®æ”¹ ${form.name} çš„è¨‚ä½`
            ),
            
            // Time and Date
            React.createElement("div", { className: "bg-white p-5 rounded-2xl shadow-sm border border-gray-100" },
                React.createElement("h3", { className: "font-bold text-gray-700 mb-4 flex items-center gap-2" }, 
                    React.createElement(Icon, { name: "calendar", className: "w-5 h-5 text-[#B91C1C]" }), "ç”¨é¤æ™‚é–“"
                ),
                React.createElement("div", { className: "mb-4 flex items-center gap-4" }, 
                    React.createElement("span", { className: "label-text whitespace-nowrap" }, "é¸æ“‡æœˆä»½"),
                    React.createElement("input", { type: "month", value: viewMonth, min: new Date().toISOString().slice(0, 7), onChange: e => setViewMonth(e.target.value), className: "input-field py-2" })
                ),
                React.createElement("div", { className: "mb-2" }, React.createElement("span", { className: "label-text" }, "é¸æ“‡æ—¥æœŸ (é€±ä¸€å…¬ä¼‘)"), !form.date && React.createElement("span", { className: "text-xs text-red-500 font-bold ml-2 animate-pulse" }, "* è«‹é¸æ“‡æ—¥æœŸ")),
                React.createElement("div", { className: "flex overflow-x-auto gap-3 pb-4 no-scrollbar -mx-2 px-2" },
                    daysInMonth.map(d => {
                        const dateStr = d.toISOString().split('T')[0];
                        return React.createElement(DateCard, { 
                            key: dateStr, 
                            date: d, 
                            isSelected: form.date === dateStr, 
                            onSelect: () => setForm({...form, date: dateStr, time: ''}) 
                        });
                    })
                ),
                React.createElement("div", { className: "mt-4 space-y-3" },
                    React.createElement("span", { className: "label-text" }, "åˆé¤æ™‚æ®µ"),
                    React.createElement("div", { className: "grid grid-cols-5 gap-2" },
                        lunchSlots.map(t => React.createElement(TimeSlotButton, { key: t, time: t }))
                    ),
                    React.createElement("span", { className: "label-text mt-2 block" }, "æ™šé¤æ™‚æ®µ"),
                    React.createElement("div", { className: "grid grid-cols-5 gap-2" },
                        dinnerSlots.map(t => React.createElement(TimeSlotButton, { key: t, time: t }))
                    )
                )
            ),
            React.createElement("div", { className: "bg-white p-5 rounded-2xl shadow-sm border border-gray-100" },
                React.createElement("h3", { className: "font-bold text-gray-700 mb-4 flex items-center gap-2" }, React.createElement(Icon, { name: "user", className: "w-5 h-5 text-purple-600" }), "äººæ•¸èˆ‡éœ€æ±‚"),
                React.createElement("div", { className: "flex justify-between items-center mb-6" },
                    React.createElement(NumberInput, { label: "å¤§äºº", value: form.adults, onChange: (v) => setForm({ ...form, adults: v }), min: 1 }),
                    React.createElement("div", { className: "w-px h-10 bg-gray-200" }),
                    React.createElement(NumberInput, { label: "å°å­©", value: form.children, onChange: (v) => setForm({ ...form, children: v }) }),
                    React.createElement("div", { className: "w-px h-10 bg-gray-200" }),
                    React.createElement(NumberInput, { label: "å…’ç«¥æ¤…", value: form.highChairs, onChange: (v) => setForm({ ...form, highChairs: v }), max: form.children, disabled: form.children === 0 })
                ),
                 React.createElement("div", { className: "mt-4 flex items-center justify-between bg-gray-50 p-3 rounded-lg" },
                    React.createElement("span", { className: "text-sm font-bold text-gray-600" }, "ç´ é£Ÿéœ€æ±‚"),
                    React.createElement("label", { className: "inline-flex items-center cursor-pointer" },
                        React.createElement("input", { type: "checkbox", checked: form.vegetarian, onChange: (e) => setForm({...form, vegetarian: e.target.checked}), className: "sr-only peer" }),
                        React.createElement("div", { className: "relative w-11 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#B91C1C]" })
                    )
                 )
            ),
            React.createElement("div", { className: "bg-white p-5 rounded-2xl shadow-sm border border-gray-100" },
                React.createElement("h3", { className: "font-bold text-gray-700 mb-4 flex items-center gap-2" }, React.createElement(Icon, { name: "phone", className: "w-5 h-5 text-blue-600" }), "è¯çµ¡è³‡è¨Š"),
                React.createElement("div", { className: "space-y-4" },
                    React.createElement("div", null, React.createElement("span", { className: "label-text" }, "è¯çµ¡å§“å"), React.createElement("input", { className: "input-field", required: true, value: form.name, onChange: e => setForm({ ...form, name: e.target.value }) })),
                    React.createElement("div", null, React.createElement("span", { className: "label-text" }, "è¯çµ¡é›»è©±"), React.createElement("input", { type: "tel", className: "input-field", required: true, value: form.phone, onChange: e => setForm({ ...form, phone: e.target.value }) })),
                    React.createElement("div", null, React.createElement("span", { className: "label-text" }, "ç‰¹æ®Šéœ€æ±‚å‚™è¨»"), React.createElement("textarea", { className: "input-field", rows: "2", value: form.notes, onChange: e => setForm({ ...form, notes: e.target.value }) }))
                )
            ),
            React.createElement("p", {className: "text-xs text-center text-gray-400 px-4"}, "ç‚ºç¢ºä¿æœå‹™å“è³ªï¼Œç·šä¸Šåƒ…æ¥å—40äººå…§è¨‚ä½ï¼Œè‹¥æœ‰å…¶ä»–éœ€æ±‚è«‹ä¾†é›»æ´½è©¢ã€‚"),
            React.createElement("div", { className: "fixed bottom-6 left-6 right-6 z-20 flex gap-2" },
                 mode === 'EDIT' && React.createElement("button", { type: "button", onClick: handleCancel, className: "flex-1 bg-gray-500 text-white py-4 rounded-xl font-bold shadow-xl transition-all active:scale-95" }, "å–æ¶ˆè¨‚ä½"),
                 React.createElement("button", { type: "submit", disabled: submitting, className: "flex-[2] bg-[#B91C1C] text-white py-4 rounded-xl font-bold shadow-xl shadow-red-200 disabled:bg-gray-400 transition-all active:scale-95" }, submitting ? "è™•ç†ä¸­..." : (mode === 'EDIT' ? "ç¢ºèªä¿®æ”¹" : "ç¢ºèªé€å‡º"))
            )
        );
    };

    const MemberView = ({ member, profile, onMemberUpdate, onMemberDelete, setView }) => {
      const [isEditing, setIsEditing] = useState(false);
      const [showFeedback, setShowFeedback] = useState(false);
      const [rating, setRating] = useState(0);
      const [comment, setComment] = useState("");
      const [submittingFeedback, setSubmittingFeedback] = useState(false);
      const [form, setForm] = useState(member || {});

      const handleUpdate = async () => {
        const res = await runGAS('updateMember', { ...form, lineUserId: profile?.userId });
        if (res.status === 'success') {
          onMemberUpdate(res.member);
          setIsEditing(false);
          Swal.fire({ icon: 'success', title: 'æ›´æ–°æˆåŠŸ', showConfirmButton: false, timer: 1500 });
        } else {
          Swal.fire({ icon: 'error', title: 'æ›´æ–°å¤±æ•—', text: res.message, confirmButtonColor: '#D32F2F' });
        }
      };
      
      const handleDelete = async () => {
        Swal.fire({
          title: 'ç¢ºå®šè¦åˆªé™¤æœƒå“¡å—?',
          text: "åˆªé™¤å¾Œï¼Œæ‚¨çš„é»æ•¸èˆ‡æœƒå“¡è³‡æ–™å°‡ç„¡æ³•å¾©åŸï¼",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#D32F2F',
          confirmButtonText: 'ç¢ºå®šåˆªé™¤'
        }).then(async (result) => {
          if (result.isConfirmed) {
            const res = await runGAS('deleteMember', { lineUserId: profile?.userId });
            if (res.status === 'success') {
              onMemberDelete();
              Swal.fire('å·²åˆªé™¤', 'æ‚¨çš„æœƒå“¡è³‡æ–™å·²æˆåŠŸåˆªé™¤ã€‚', 'success');
            }
          }
        })
      };

      const handleSubmitFeedback = async () => {
            if (rating === 0) {
                Swal.fire({ icon: 'warning', title: 'è«‹çµ¦æ˜Ÿç´šè©•åˆ†', text: 'è«‹è‡³å°‘é¸æ“‡ä¸€é¡†æ˜Ÿ', confirmButtonColor: '#D32F2F' });
                return;
            }
            setSubmittingFeedback(true);
            const res = await runGAS('submitFeedback', { lineUserId: profile?.userId, name: profile?.displayName, rating, comment });
            if (res.status === 'success') {
                Swal.fire('æ„Ÿè¬æ‚¨çš„å›é¥‹ï¼', 'æ‚¨çš„æ„è¦‹æ˜¯æˆ‘å€‘é€²æ­¥çš„å‹•åŠ›', 'success');
                setShowFeedback(false); setRating(0); setComment("");
            } else {
                Swal.fire({ icon: 'error', title: 'æäº¤å¤±æ•—', text: res.message, confirmButtonColor: '#D32F2F' });
            }
            setSubmittingFeedback(false);
      };

      if (!member) {
        const [regForm, setRegForm] = useState({ 
            name: profile?.displayName || '', phone: '', birthday: '', gender: 'ç”·', email: profile?.email || '' 
        });
        const [submitting, setSubmitting] = useState(false);
        const handleReg = async e => {
            e.preventDefault();
            const phoneRegex = /^09\d{8}$/;
            if (!phoneRegex.test(regForm.phone)) {
                Swal.fire({ icon: 'error', title: 'æ ¼å¼éŒ¯èª¤', text: 'è«‹è¼¸å…¥æœ‰æ•ˆçš„ 10 ä½æ‰‹æ©Ÿè™Ÿç¢¼ï¼Œå¿…é ˆä»¥ 09 é–‹é ­ã€‚', confirmButtonColor: '#D32F2F' });
                return;
            }
            setSubmitting(true);
            const res = await runGAS('register', { ...regForm, lineUserId: profile?.userId });
            if (res.status === 'success') { 
                onMemberUpdate(res.member); 
                Swal.fire({ icon: 'success', title: 'æ­¡è¿åŠ å…¥!', text: 'å·²ç²å¾—æ–°æœƒå“¡é»æ•¸ 100 é»', confirmButtonColor: '#B91C1C' });
            } else { 
                Swal.fire({ icon: 'error', title: 'è¨»å†Šå¤±æ•—', text: res.message, confirmButtonColor: '#D32F2F' });
            }
            setSubmitting(false);
        };
        return React.createElement("form", { onSubmit: handleReg, className: "p-6 space-y-6" },
             React.createElement("div", { className: "text-center mb-6" },
                React.createElement("h2", { className: "text-2xl font-bold text-[#B91C1C]" }, "åŠ å…¥æœƒå“¡"),
                React.createElement("p", { className: "text-gray-500 text-sm mt-1" }, "äº«å—å°ˆå±¬å„ªæƒ èˆ‡ç´¯é»å›é¥‹")
             ),
             [
              { label: "æ‚¨çš„å§“å", type: "text", val: regForm.name, key: "name", required: true },
              { label: "æ‰‹æ©Ÿè™Ÿç¢¼", type: "tel", val: regForm.phone, key: "phone", required: true },
              { label: "é›»å­ä¿¡ç®±", type: "email", val: regForm.email, key: "email", required: false },
             ].map((field, idx) => 
              React.createElement("div", { key: idx, className: "bg-white p-3 rounded-2xl border-2 border-[#B91C1C]/20 focus-within:border-[#B91C1C] focus-within:bg-red-50 transition-all shadow-sm" },
                  React.createElement("span", { className: "text-xs font-bold text-[#B91C1C] block mb-1 uppercase tracking-wide" }, field.label),
                  React.createElement("input", { 
                      type: field.type, 
                      className: "w-full bg-transparent outline-none text-gray-800 font-medium placeholder-gray-400", 
                      required: field.required, 
                      value: field.val, 
                      onChange: e => setRegForm({ ...regForm, [field.key]: e.target.value }) 
                  })
              )
             ),
             React.createElement("div", { className: "bg-white p-3 rounded-2xl border-2 border-[#B91C1C]/20 focus-within:border-[#B91C1C] shadow-sm" },
                React.createElement("span", { className: "text-xs font-bold text-[#B91C1C] block mb-1 uppercase tracking-wide" }, "æ€§åˆ¥"),
                React.createElement("select", { className: "w-full bg-transparent outline-none text-gray-800 font-medium", value: regForm.gender, onChange: e => setRegForm({ ...regForm, gender: e.target.value }) },
                    React.createElement("option", { value: "ç”·" }, "ç”·"),
                    React.createElement("option", { value: "å¥³" }, "å¥³"),
                    React.createElement("option", { value: "å…¶ä»–" }, "å…¶ä»–")
                )
             ),
             React.createElement("div", { className: "bg-red-50 p-4 rounded-2xl border-2 border-dashed border-red-300" },
                React.createElement("span", { className: "label-text text-red-700 flex items-center gap-1" }, React.createElement(Icon, {name:"gift", className:"w-4 h-4"}), "ğŸ‚ ç”Ÿæ—¥é©šå–œ"),
                React.createElement("input", { type: "date", className: "w-full bg-white mt-2 p-2 rounded-lg border border-red-200 outline-none", required: true, value: regForm.birthday, onChange: e => setRegForm({ ...regForm, birthday: e.target.value }) }),
                React.createElement("p", { className: "text-[10px] text-red-600 mt-2 font-bold" }, "* ç”Ÿæ—¥ç•¶æœˆè´ˆé€å°ˆå±¬ç”Ÿæ—¥é¤åˆ¸ä¹™å¼µ")
             ),
             React.createElement("button", { type: "submit", disabled: submitting, className: "w-full bg-[#B91C1C] text-white py-4 rounded-xl font-bold shadow-lg shadow-red-200 disabled:bg-gray-400 transition-all active:scale-95" }, submitting ? "è™•ç†ä¸­..." : "ç¢ºèªåŠ å…¥")
        );
      }

      return React.createElement("div", { className: "p-6 pb-24" },
        React.createElement("div", { className: "bg-gradient-to-br from-[#B91C1C] to-black p-6 rounded-2xl text-white shadow-xl relative overflow-hidden" },
            React.createElement("div", { className: "absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 blur-xl" }),
            React.createElement("div", { className: "text-xl font-bold mb-8 relative z-10" }, RESTAURANT_NAME),
            React.createElement("div", { className: "flex justify-between items-end relative z-10" },
                React.createElement("div", null, React.createElement("p", { className: "text-sm opacity-80" }, member.name), React.createElement("p", { className: "tracking-widest font-mono mt-1" }, member.phone)),
                React.createElement("div", { className: "text-right" }, React.createElement("p", { className: "text-[10px] opacity-60 uppercase" }, "Points"), React.createElement("p", { className: "text-3xl font-bold" }, member.points))
            )
        ),
        React.createElement("div", { className: "mt-4 flex gap-2" },
           React.createElement("button", { onClick: () => Swal.fire('é‚€è«‹é€£çµå·²è¤‡è£½', 'å¿«å»åˆ†äº«çµ¦å¥½å‹å§ï¼', 'success'), className: "flex-1 bg-white py-2 rounded-lg shadow-sm text-xs font-bold text-[#B91C1C] border border-[#B91C1C] flex items-center justify-center gap-1" }, React.createElement(Icon, {name:"share", className:"w-4 h-4"}), "é‚€è«‹å¥½å‹"),
           React.createElement("button", { onClick: () => Swal.fire('åŠŸèƒ½é–‹ç™¼ä¸­', 'è«‹å‡ºç¤ºæ¢ç¢¼çµ¦åº—å“¡æƒæ', 'info'), className: "flex-1 bg-white py-2 rounded-lg shadow-sm text-xs font-bold text-gray-600 border border-gray-300 flex items-center justify-center gap-1" }, React.createElement(Icon, {name:"qr", className:"w-4 h-4"}), "ç¶å®šè¼‰å…·")
        ),
        React.createElement("div", { className: "mt-6 grid grid-cols-2 gap-4" },
            [
                { id: 'MY_BOOKINGS', name: 'æˆ‘çš„è¨‚ä½', icon: 'calendar' },
                { id: 'POINT_HISTORY', name: 'é»æ•¸ç´€éŒ„', icon: 'history' },
                { id: 'COUPONS', name: 'æˆ‘çš„å„ªæƒ åˆ¸', icon: 'ticket' },
                { id: 'STAMP_CARD', name: 'é›†é»å¡', icon: 'stamp' }
            ].map(btn => React.createElement("button", { key: btn.id, onClick: () => setView(btn.id), className: "bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 active:scale-95 transition-all hover:shadow-md" },
                React.createElement("div", { className: "w-10 h-10 rounded-full bg-red-50 flex items-center justify-center text-[#B91C1C]" },
                   React.createElement(Icon, { name: btn.icon, className: "w-6 h-6" })
                ),
                React.createElement("span", { className: "font-bold text-sm text-gray-700" }, btn.name)
            ))
        ),
        React.createElement("div", { className: "mt-6 bg-white rounded-xl p-4 border border-gray-100 space-y-3 shadow-sm" },
            isEditing ?
            React.createElement(React.Fragment, null, 
                React.createElement("div", null, React.createElement("span", { className: "label-text" }, "å§“å"), React.createElement("input", { className: "input-field", value: form.name, onChange: e => setForm({ ...form, name: e.target.value }) })),
                React.createElement("div", null, React.createElement("span", { className: "label-text" }, "é›»è©±"), React.createElement("input", { className: "input-field", value: form.phone, onChange: e => setForm({ ...form, phone: e.target.value }) })),
                React.createElement("div", null, React.createElement("span", { className: "label-text" }, "ç”Ÿæ—¥"), React.createElement("input", { type: "date", className: "input-field", value: form.birthday, onChange: e => setForm({ ...form, birthday: e.target.value }) })),
                React.createElement("div", { className: "flex gap-2 pt-2"},
                    React.createElement("button", { onClick: handleUpdate, className: "w-full bg-green-600 text-white py-2 rounded-lg font-bold" }, "å„²å­˜"),
                    React.createElement("button", { onClick: () => { setIsEditing(false); setForm(member); }, className: "w-full bg-gray-200 py-2 rounded-lg" }, "å–æ¶ˆ"),
                )
            ) :
            React.createElement(React.Fragment, null,
                React.createElement("div", { className: "flex items-center justify-between" },
                   React.createElement("span", { className: "text-sm font-bold text-gray-500" }, "æœƒå“¡è³‡æ–™ç®¡ç†"),
                   React.createElement("div", { className: "flex gap-2" },
                      React.createElement("button", { onClick: () => setIsEditing(true), className: "flex items-center gap-1 text-xs bg-gray-100 px-3 py-1.5 rounded-full text-gray-600 hover:bg-gray-200" }, React.createElement(Icon, {name:"edit", className:"w-3 h-3"}), "ä¿®æ”¹"),
                      React.createElement("button", { onClick: handleDelete, className: "flex items-center gap-1 text-xs bg-red-50 text-red-600 px-3 py-1.5 rounded-full hover:bg-red-100" }, React.createElement(Icon, {name:"trash", className:"w-3 h-3"}), "åˆªé™¤")
                   )
                )
            )
        ),
        React.createElement("div", { className: "mt-6" },
            !showFeedback ? 
                React.createElement("button", { onClick: () => setShowFeedback(true), className: "w-full bg-yellow-500 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-yellow-200" }, React.createElement(Icon, {name:"star", className:"w-5 h-5"}), "å¡«å¯«ç”¨é¤å›é¥‹ (å®Œé£Ÿå¾Œ)")
                :
                React.createElement("div", { className: "p-4 bg-white rounded-xl shadow-md border animate-fade-in" },
                    React.createElement("h3", { className: "font-bold text-gray-700 mb-2" }, "æ‚¨çš„å¯¶è²´æ„è¦‹"),
                    React.createElement("div", { className: "flex justify-center my-4" }, 
                        [1, 2, 3, 4, 5].map(star => React.createElement("button", { key: star, onClick: () => setRating(star) }, React.createElement(Icon, { name: "star", className: `w-8 h-8 ${rating >= star ? 'text-yellow-400 fill-current' : 'text-gray-300'}` })))
                    ),
                    React.createElement("textarea", { value: comment, onChange: e => setComment(e.target.value), className: "input-field", placeholder: "è«‹åˆ†äº«æ‚¨çš„ç”¨é¤é«”é©—...", rows: 3 }),
                    React.createElement("div", { className: "flex gap-2 mt-2" },
                        React.createElement("button", { onClick: handleSubmitFeedback, disabled: submittingFeedback, className: "w-full bg-[#B91C1C] text-white py-2 rounded-lg disabled:bg-gray-400" }, submittingFeedback ? "å‚³é€ä¸­..." : "é€å‡º"),
                        React.createElement("button", { onClick: () => setShowFeedback(false), className: "w-full bg-gray-200 py-2 rounded-lg" }, "å–æ¶ˆ")
                    )
                )
        )
      );
    };

    const MyBookingsView = ({ profile }) => {
        const [bookings, setBookings] = useState([]);
        const [loading, setLoading] = useState(true);
        useEffect(() => {
            if(!profile) return;
            runGAS('getUserBookings', { lineUserId: profile.userId })
                .then(res => {
                    if (res.status === 'success') setBookings(res.bookings.reverse());
                })
                .finally(() => setLoading(false));
        }, [profile]);

        if (loading) return React.createElement("p", {className: "text-center p-8"}, "è®€å–ä¸­...");
        if (bookings.length === 0) return React.createElement("p", {className: "text-center text-gray-500 p-8"}, "æ‚¨ç›®å‰æ²’æœ‰ä»»ä½•è¨‚ä½ç´€éŒ„ã€‚");

        return React.createElement("div", {className: "p-4 space-y-4"},
            bookings.map((b, i) => {
                let dateDisplay = b['é ç´„æ—¥æœŸ'];
                try {
                    const dateObj = new Date(b['é ç´„æ—¥æœŸ']);
                    if (!isNaN(dateObj.getTime())) {
                        dateDisplay = dateObj.toLocaleDateString();
                    }
                } catch(e) {}

                return React.createElement("div", {key: i, className: "bg-white p-4 rounded-xl shadow-sm border border-gray-100"},
                    React.createElement("div", { className: "flex justify-between items-start" },
                        React.createElement("div", null,
                            React.createElement("div", { className: "flex items-center gap-2 mb-1" },
                                React.createElement("span", { className: "text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded font-mono" }, b['è¨‚ä½ä»£è™Ÿ'] || '---'),
                                React.createElement("p", {className: "font-bold text-lg text-gray-800"}, dateDisplay)
                            ),
                            React.createElement("p", {className: "text-[#B91C1C] font-bold"}, b['é ç´„æ™‚é–“'])
                        ),
                        React.createElement("span", { className: "bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded" }, `${b['å¤§äºº']}å¤§${b['å°å­©']}å°`)
                    ),
                    b['é é»é¤'] && React.createElement("div", {className: "mt-3 pt-3 border-t border-dashed border-gray-200"},
                        React.createElement("p", {className: "text-xs text-gray-500 mb-1"}, "é é»é¤é»"),
                        React.createElement("p", {className: "text-sm text-gray-700 whitespace-pre-wrap"}, b['é é»é¤'].replace(/;/g, '\n'))
                    )
                );
            })
        );
    };

    const PointHistoryView = ({ profile }) => {
        const [history, setHistory] = useState([]);
        const [loading, setLoading] = useState(true);
        useEffect(() => {
            if(!profile) return;
            runGAS('getPointHistory', { lineUserId: profile.userId })
                .then(res => { if (res.status === 'success') setHistory(res.history.reverse()); })
                .finally(() => setLoading(false));
        }, [profile]);
        
        if (loading) return React.createElement("p", {className: "text-center p-8"}, "è®€å–ä¸­...");
        if (history.length === 0) return React.createElement("p", {className: "text-center text-gray-500 p-8"}, "æ‚¨æ²’æœ‰ä»»ä½•é»æ•¸ç´€éŒ„ã€‚");
        return React.createElement("div", {className: "p-4 space-y-2"}, history.map((h, i) => React.createElement("div", {key: i, className: "flex justify-between items-center p-4 bg-white rounded-xl border border-gray-100"}, React.createElement("div", null, React.createElement("p", {className: "font-bold text-gray-800"}, h.èªªæ˜), React.createElement("p", {className: "text-xs text-gray-400 mt-0.5"}, new Date(h.æ™‚é–“).toLocaleString())), React.createElement("p", {className: `font-bold text-lg ${h.é»æ•¸è®ŠåŒ– > 0 ? 'text-green-600' : 'text-red-600'}`}, `${h.é»æ•¸è®ŠåŒ– > 0 ? '+' : ''}${h.é»æ•¸è®ŠåŒ–}`))));
    };

    const CouponsView = ({ profile }) => {
         const mockCoupons = [{ id: 1, title: 'ç”Ÿæ—¥95æŠ˜åˆ¸', desc: 'é™ç”Ÿæ—¥ç•¶æœˆä½¿ç”¨ä¹™æ¬¡', expiry: '2024-12-31' }, { id: 2, title: 'è–¯æ¢å…Œæ›åˆ¸', desc: 'æ¶ˆè²»æ»¿$500å³å¯ä½¿ç”¨', expiry: '2024-08-31' }];
         const [usedCoupons, setUsedCoupons] = useState(() => {
             try { return JSON.parse(localStorage.getItem('used_coupons') || '[]'); } catch(e) { return []; }
         });

         const handleRedeem = (coupon) => {
             Swal.fire({
                 title: 'è«‹åº—å“¡è¼¸å…¥æ ¸éŠ·ç¢¼',
                 input: 'password',
                 inputAttributes: { autocapitalize: 'off', placeholder: 'é è¨­: 8888' },
                 showCancelButton: true,
                 confirmButtonText: 'ç¢ºèªæ ¸éŠ·',
                 confirmButtonColor: '#B91C1C',
                 showLoaderOnConfirm: true,
                 preConfirm: (code) => {
                     if (code === '8888') {
                         return true;
                     } else {
                         Swal.showValidationMessage('æ ¸éŠ·ç¢¼éŒ¯èª¤');
                     }
                 }
             }).then((result) => {
                 if (result.isConfirmed) {
                     const newUsed = [...usedCoupons, coupon.id];
                     setUsedCoupons(newUsed);
                     localStorage.setItem('used_coupons', JSON.stringify(newUsed));
                     Swal.fire({ title: 'æ ¸éŠ·æˆåŠŸ', icon: 'success', timer: 1500, showConfirmButton: false });
                 }
             });
         };

         return React.createElement("div", {className: "p-4 space-y-4"}, mockCoupons.map((c, i) => {
             const isUsed = usedCoupons.includes(c.id);
             return React.createElement("div", {key: i, className: `relative border-l-4 p-4 rounded-r-xl shadow-sm flex items-center gap-4 ${isUsed ? 'bg-gray-100 border-gray-400 opacity-60' : 'bg-white border-yellow-400'}`}, 
                React.createElement("div", { className: `p-2 rounded-full ${isUsed ? 'bg-gray-200 text-gray-500' : 'bg-yellow-50 text-yellow-500'}`}, React.createElement(Icon, {name: 'ticket', className: 'w-6 h-6'})), 
                React.createElement("div", { className: "flex-1" }, 
                    React.createElement("p", {className: "font-bold text-gray-800"}, c.title), 
                    React.createElement("p", {className: "text-xs text-gray-500 mt-1"}, c.desc), 
                    React.createElement("p", {className: "text-[10px] text-gray-400 mt-1"}, `æœ‰æ•ˆæœŸé™ï¼š${c.expiry}`)
                ), 
                isUsed ? 
                React.createElement("div", { className: "text-xs font-bold text-gray-500 border border-gray-400 px-3 py-1 rounded-full transform -rotate-12" }, "å·²ä½¿ç”¨") :
                React.createElement("button", { onClick: () => handleRedeem(c), className: "text-xs bg-gray-800 text-white px-3 py-1.5 rounded-full hover:bg-gray-700 active:scale-95" }, "ä½¿ç”¨")
             );
         }));
    };

    const StampCardView = () => {
        const totalStamps = 10; const currentStamps = 6;
        return React.createElement("div", {className: "p-6"}, React.createElement("div", {className: "bg-white p-6 rounded-2xl shadow-lg border border-gray-100"}, React.createElement("div", { className: "text-center mb-6" }, React.createElement("h3", {className: "font-bold text-xl text-[#B91C1C]"}, "æ¶ˆè²»é›†é»å¡"), React.createElement("p", {className: "text-xs text-gray-500 mt-2"}, "å–®ç­†æ¶ˆè²»æ»¿ $300 ç´¯ç© 1 é»ï¼Œé›†æ»¿ 10 é»å…Œæ›å¥½ç¦®")), React.createElement("div", {className: "grid grid-cols-5 gap-4 mb-6"}, [...Array(totalStamps)].map((_, i) => React.createElement("div", {key: i, className: `aspect-square rounded-full flex items-center justify-center border-2 ${i < currentStamps ? 'bg-yellow-400 border-yellow-400' : 'bg-gray-50 border-gray-200'}`}, i < currentStamps && React.createElement(Icon, {name: 'star', className: 'w-5 h-5 text-white fill-current'})))), React.createElement("div", { className: "w-full bg-gray-100 rounded-full h-2.5 mb-2" }, React.createElement("div", { className: "bg-[#B91C1C] h-2.5 rounded-full", style: { width: `${(currentStamps/totalStamps)*100}%` } })), React.createElement("p", {className: "text-right text-xs font-bold text-[#B91C1C]"}, `é€²åº¦ï¼š${currentStamps} / ${totalStamps}`)));
    };

    const PreorderView = ({ booking, restaurantMenu, onBack }) => {
        const fallbackMenu = [
            { category: "ç¾©å¤§åˆ©éºµ", sub: "ä¸»å»šæ¨è–¦", n: "å®®ä¿è¾£å‘³é›ä¸ç¾©å¤§åˆ©éºµ", p: 0 }, 
            { category: "ç¾©å¤§åˆ©éºµ", sub: "ä¸»å»šæ¨è–¦", n: "æ¥µå“X.Oé†¬æµ·é®®ç¾©å¤§åˆ©éºµ", p: 250, special: true },
            { category: "ç¾©å¤§åˆ©éºµ", sub: "ä¸»å»šæ¨è–¦", n: "å¢¨é­šæ±æµ·é®®å¢¨é­šéºµ", p: 260, special: true },
            { category: "ç¾©å¤§åˆ©éºµ", sub: "ç™½é†¬", n: "å¥¶æ²¹åŸ¹æ ¹ç¾©å¤§åˆ©éºµ", p: 170 },
            { category: "ç¾©å¤§åˆ©éºµ", sub: "ç™½é†¬", n: "å¥¶æ²¹è›¤èœŠç¾©å¤§åˆ©éºµ", p: 220 },
            { category: "ç¾©å¤§åˆ©éºµ", sub: "èŒ„æ±", n: "æ³¢éš†é‚£è‚‰é†¬ç¾©å¤§åˆ©éºµ", p: 170, tags: ['ç‰›'] },
            { category: "ç¾©å¼ç‡‰é£¯", sub: "åŸºæœ¬æ¬¾", n: "å—ç“œæ™‚è”¬ç‡‰é£¯", p: 180, tags: ['ç´ '] },
            { category: "PIZZA", sub: "", n: "ç¾©å¼è‚‰é†¬é‡è‡æŠ«è–©", p: 160, tags: ['ç‰›'] },
            { category: "å–®é»", sub: "ç‚¸ç‰©", n: "éº¥å…‹é›å¡Š", p: 80 },
            { category: "é£²å“", sub: "", n: "å¯æ¨‚", p: 50 },
        ];

        const menuItems = (restaurantMenu && restaurantMenu.length > 0) 
            ? restaurantMenu.map(i => ({ category: i['é¡åˆ¥'], sub: i['å­é¡åˆ¥'], n: i['ç”¢å“åç¨±'], p: Number(i['ç”¢å“åƒ¹æ ¼']), img: i['åœ–ç‰‡ç¶²å€'], tags: i['æ¨™ç±¤'] ? i['æ¨™ç±¤'].split(',') : [] })) 
            : fallbackMenu;

        const categories = ["ç¾©å¤§åˆ©éºµ", "ç¾©å¼ç‡‰é£¯", "ç„—çƒ¤", "PIZZA", "å–®é»", "é£²å“"];
        const [activeCategory, setActiveCategory] = useState(categories[0]);
        const [cart, setCart] = useState([]);
        const [showCartModal, setShowCartModal] = useState(false);
        const [selectedItem, setSelectedItem] = useState(null); 
        const [itemOptions, setItemOptions] = useState({ noodle: 'ç­†å°–éºµ', spice: 'ä¸è¾£', combo: 0, drink: '' });

        const noodleOptions = [
            { n: "ç­†å°–éºµ", p: 0 }, { n: "å¤©ä½¿ç´°éºµ", p: 10 }, { n: "é€šå¿ƒéºµ", p: 10 }, { n: "ç´°æ‰éºµ", p: 10 }, { n: "å¢¨é­šéºµ", p: 40 }
        ];
        const spiceOptions = ["ä¸è¾£", "å°è¾£", "ä¸­è¾£", "å¤§è¾£"];
        const comboOptions = [
            { id: 0, n: "å–®é»", p: 0 },
            { id: 1, n: "è¶…å€¼å¥—é¤", p: 80, desc: "å«é£²å“" },
            { id: 2, n: "é…¥çš®å¥—é¤", p: 130, desc: "å«é£²å“+é…¥çš®æ¿ƒæ¹¯" }
        ];
        const drinkOptions = menuItems.filter(i => i.category === "é£²å“").map(i => i.n);

        const openItemModal = (item) => {
            setSelectedItem(item);
            setItemOptions({ 
                noodle: (item.category === "ç¾©å¤§åˆ©éºµ") ? 'ç­†å°–éºµ' : '', 
                spice: 'ä¸è¾£', 
                combo: 0, 
                drink: '' 
            });
        };

        const addToCartFromModal = () => {
            if (itemOptions.combo > 0 && !itemOptions.drink) {
                Swal.fire({ icon: 'warning', title: 'è«‹é¸æ“‡é£²æ–™', text: 'å¥—é¤å¿…é ˆé¸æ“‡é£²å“', confirmButtonColor: '#B91C1C' });
                return;
            }
            const itemTotal = selectedItem.p + (itemOptions.combo === 1 ? 80 : itemOptions.combo === 2 ? 130 : 0) + (noodleOptions.find(n=>n.n === itemOptions.noodle)?.p || 0);
            const newItem = {
                ...selectedItem, ...itemOptions, unitPrice: itemTotal, qty: 1, cartId: Date.now() 
            };
            setCart(prev => [...prev, newItem]);
            setSelectedItem(null);
            Swal.fire({ icon: 'success', title: 'å·²åŠ å…¥è³¼ç‰©è»Š', showConfirmButton: false, timer: 800 });
        };

        const removeFromCart = (cartId) => {
            setCart(prev => prev.filter(i => i.cartId !== cartId));
        };

        const total = useMemo(() => cart.reduce((sum, item) => sum + item.unitPrice * item.qty, 0), [cart]);
        const minChargePerPerson = 60;
        const payingPeople = parseInt(booking?.adults) || 0; 
        const requiredTotal = minChargePerPerson * payingPeople;

        const handleSubmit = async () => {
            if (total < requiredTotal) {
                 Swal.fire({ 
                     icon: 'warning', 
                     title: 'æœªé”ä½æ¶ˆ', 
                     text: `æ¯äººä½æ¶ˆ $${minChargePerPerson} (ä¸å«å…’ç«¥)ã€‚\nç›®å‰è¨ˆè²»äººæ•¸ ${payingPeople} äººï¼Œç¸½é‡‘é¡éœ€é” $${requiredTotal}ã€‚\né‚„å·® $${requiredTotal - total}ã€‚`, 
                     confirmButtonColor: '#D32F2F' 
                 });
                 return;
            }

            const res = await runGAS('savePreOrder', { bookingId: booking.bookingId, order: cart });
            if(res.status === 'success') {
                if (window.liff.isInClient()) {
                    const orderText = cart.map(i => {
                        let desc = `${i.n}`;
                        if(i.noodle) desc += `(${i.noodle})`;
                        if(i.spice) desc += `[${i.spice}]`;
                        if(i.combo) desc += `+${comboOptions.find(c=>c.id===i.combo).n}`;
                        if(i.drink) desc += `/${i.drink}`;
                        desc += ` x${i.qty}`;
                        return desc;
                    }).join('\n');
                    const fullMessage = booking.bookingMessageText + `\n\nğŸ” é é»é¤é»ç¢ºèªï¼š\n${orderText}\n\né é»é‡‘é¡ï¼š$${total}`;
                    await window.liff.sendMessages([{ type: 'text', text: fullMessage }]).catch(console.error);
                }
                setShowCartModal(false);
                await Swal.fire({ icon: 'success', title: 'é å…ˆé»é¤æˆåŠŸ', text: 'æ‚¨çš„é»é¤ç´€éŒ„å·²å„²å­˜ï¼ŒæœŸå¾…æ‚¨çš„å…‰è‡¨ï¼', confirmButtonColor: '#B91C1C'});
                onBack();
            } else {
                 Swal.fire({ icon: 'error', title: 'é»é¤å¤±æ•—', text: res.message, confirmButtonColor: '#D32F2F' });
            }
        };

        const filteredItems = menuItems.filter(i => i.category === activeCategory);
        const groupedItems = filteredItems.reduce((acc, item) => {
            const key = item.sub || 'å…¶å®ƒ';
            if(!acc[key]) acc[key] = [];
            acc[key].push(item);
            return acc;
        }, {});

        return React.createElement("div", { className: "flex h-full relative" },
            React.createElement("div", { className: "w-[26%] bg-gray-50 overflow-y-auto border-r border-gray-100 pb-24" },
                categories.map(cat => React.createElement("button", { key: cat, onClick: () => setActiveCategory(cat), className: `w-full text-left px-2 py-4 text-xs font-bold transition-all border-l-4 ${activeCategory === cat ? 'bg-white text-[#B91C1C] border-[#B91C1C] shadow-sm' : 'text-gray-500 border-transparent hover:bg-gray-100'}` }, cat))
            ),
            React.createElement("div", { className: "w-[74%] p-4 overflow-y-auto pb-36 bg-white" },
                React.createElement("div", { className: "bg-red-50 p-2 mb-4 rounded-lg text-[10px] text-red-700 font-bold border border-red-100 flex items-center gap-1" }, 
                   React.createElement(Icon, {name:"info", className:"w-3 h-3"}), `ä½æ¶ˆæé†’ï¼šå…±éœ€ $${requiredTotal}`
                ),
                Object.keys(groupedItems).map(sub => 
                    React.createElement("div", { key: sub, className: "mb-6" },
                        sub !== 'å…¶å®ƒ' && React.createElement("h4", { className: "font-bold text-gray-400 text-sm mb-2 sticky top-0 bg-white py-1" }, sub),
                        React.createElement("div", { className: "space-y-3" },
                            groupedItems[sub].map((item, idx) => 
                                React.createElement("div", { key: idx, onClick: () => openItemModal(item), className: "flex bg-white rounded-lg border border-gray-100 shadow-sm overflow-hidden active:scale-95 transition-transform cursor-pointer" },
                                    item.img && React.createElement("img", { src: item.img, className: "w-20 h-20 object-cover" }),
                                    React.createElement("div", { className: "p-2 flex-1 flex flex-col justify-between" },
                                        React.createElement("div", null,
                                            React.createElement("p", { className: "font-bold text-gray-800 text-sm leading-tight" }, item.n),
                                            React.createElement("div", { className: "flex gap-1 mt-1 flex-wrap" },
                                                item.tags && item.tags.includes('è¾£') && React.createElement("span", { className: "text-[9px] bg-red-100 text-red-600 px-1 rounded" }, "ğŸŒ¶ï¸"),
                                                item.tags && item.tags.includes('ç‰›') && React.createElement("span", { className: "text-[9px] bg-amber-100 text-amber-700 px-1 rounded" }, "ğŸ®"),
                                                item.tags && item.tags.includes('ç´ ') && React.createElement("span", { className: "text-[9px] bg-green-100 text-green-700 px-1 rounded" }, "ğŸ¥¦")
                                            )
                                        ),
                                        React.createElement("div", { className: "flex justify-between items-end" },
                                            React.createElement("p", { className: "font-bold text-[#B91C1C]" }, `$${item.p}`),
                                            React.createElement("div", { className: "bg-[#B91C1C] text-white w-5 h-5 rounded-full flex items-center justify-center font-bold text-lg" }, "+")
                                        )
                                    )
                                )
                            )
                        )
                    )
                )
            ),
            cart.length > 0 && !showCartModal && !selectedItem && React.createElement("div", { className: "fixed bottom-6 left-4 right-4 bg-[#B91C1C] text-white p-3 rounded-xl shadow-2xl z-30 flex justify-between items-center cursor-pointer active:scale-95 transition-transform animate-slide-up", onClick: () => setShowCartModal(true) },
                React.createElement("div", { className: "flex items-center gap-3" },
                    React.createElement("div", { className: "bg-white text-[#B91C1C] font-bold w-8 h-8 rounded-full flex items-center justify-center" }, cart.length),
                    React.createElement("span", { className: "font-bold text-lg" }, `$${total}`)
                ),
                React.createElement("span", { className: "font-bold text-sm" }, "æŸ¥çœ‹æ˜ç´° >")
            ),
            selectedItem && React.createElement("div", { className: "fixed inset-0 z-50 flex items-end justify-center bg-black/60 backdrop-blur-sm animate-fade-in" },
                React.createElement("div", { className: "bg-white w-full max-h-[90vh] rounded-t-2xl shadow-2xl flex flex-col animate-slide-up overflow-hidden" },
                    React.createElement("div", { className: "p-4 bg-gray-50 border-b flex justify-between items-start" },
                        React.createElement("div", null,
                            React.createElement("h3", { className: "font-bold text-lg text-gray-800" }, selectedItem.n),
                            React.createElement("p", { className: "text-[#B91C1C] font-bold" }, `$${selectedItem.p}`)
                        ),
                        React.createElement("button", { onClick: () => setSelectedItem(null), className: "bg-gray-200 rounded-full p-1" }, React.createElement(Icon, {name:"close", className:"w-5 h-5"}))
                    ),
                    React.createElement("div", { className: "flex-1 overflow-y-auto p-4 space-y-6" },
                        selectedItem.category === "ç¾©å¤§åˆ©éºµ" && React.createElement("div", null,
                            React.createElement("h4", { className: "font-bold text-sm mb-2 flex items-center gap-1" }, "é¸æ“‡éºµæ¢", React.createElement("span", {className:"text-[10px] text-red-500"}, "*å¿…é¸")),
                            React.createElement("div", { className: "grid grid-cols-2 gap-2" },
                                noodleOptions.map(opt => React.createElement("button", { 
                                    key: opt.n, 
                                    onClick: () => setItemOptions({...itemOptions, noodle: opt.n}),
                                    className: `py-2 text-xs border rounded-lg ${itemOptions.noodle === opt.n ? 'bg-red-50 border-[#B91C1C] text-[#B91C1C] font-bold' : 'border-gray-200 text-gray-600'}` 
                                }, `${opt.n} ${opt.p > 0 ? `(+$${opt.p})` : ''}`))
                            )
                        ),
                        React.createElement("div", null,
                            React.createElement("h4", { className: "font-bold text-sm mb-2" }, "è¾£åº¦èª¿æ•´"),
                            React.createElement("div", { className: "flex gap-2" },
                                spiceOptions.map(s => React.createElement("button", { 
                                    key: s, 
                                    onClick: () => setItemOptions({...itemOptions, spice: s}),
                                    className: `flex-1 py-2 text-xs border rounded-lg ${itemOptions.spice === s ? 'bg-red-50 border-[#B91C1C] text-[#B91C1C] font-bold' : 'border-gray-200 text-gray-600'}` 
                                }, s))
                            )
                        ),
                        React.createElement("div", { className: "bg-yellow-50 p-3 rounded-xl border border-yellow-200" },
                            React.createElement("h4", { className: "font-bold text-sm mb-2 text-yellow-800" }, "âœ¨ è¶…å€¼å‡ç´šï¼Ÿ"),
                            React.createElement("div", { className: "space-y-2" },
                                comboOptions.map(c => React.createElement("label", { key: c.id, className: "flex items-center justify-between p-2 bg-white rounded-lg border cursor-pointer" },
                                    React.createElement("div", { className: "flex items-center gap-2" },
                                        React.createElement("input", { type: "radio", name: "combo", checked: itemOptions.combo === c.id, onChange: () => setItemOptions({...itemOptions, combo: c.id, drink: ''}), className: "accent-[#B91C1C]" }),
                                        React.createElement("div", null,
                                            React.createElement("p", { className: "text-sm font-bold" }, c.n),
                                            c.desc && React.createElement("p", { className: "text-[10px] text-gray-500" }, c.desc)
                                        )
                                    ),
                                    React.createElement("span", { className: "text-xs font-bold text-[#B91C1C]" }, `+$${c.p}`)
                                ))
                            )
                        ),
                        itemOptions.combo > 0 && React.createElement("div", { className: "animate-fade-in" },
                            React.createElement("h4", { className: "font-bold text-sm mb-2 flex items-center gap-1" }, "é¸æ“‡é£²å“", React.createElement("span", {className:"text-[10px] text-red-500"}, "*å¿…é¸")),
                            React.createElement("select", { 
                                value: itemOptions.drink, 
                                onChange: (e) => setItemOptions({...itemOptions, drink: e.target.value}),
                                className: "w-full p-2 border border-gray-300 rounded-lg text-sm bg-white"
                            },
                                React.createElement("option", { value: "" }, "è«‹é¸æ“‡é£²æ–™..."),
                                drinkOptions.map(d => React.createElement("option", { key: d, value: d }, d))
                            )
                        )
                    ),
                    React.createElement("div", { className: "p-4 border-t bg-white pb-safe" },
                        React.createElement("button", { onClick: addToCartFromModal, className: "w-full bg-[#B91C1C] text-white py-3 rounded-xl font-bold shadow-lg shadow-red-200 active:scale-95 transition-transform" }, "åŠ å…¥è³¼ç‰©è»Š")
                    )
                )
            )
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
  </script>
</head>
<body>
  <div id="root"></div>
</body>
</html>