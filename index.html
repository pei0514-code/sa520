<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ëñ©Ë´æÁì¶Áæ©ÂºèÂªöÊàø</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root {
      --brand-green: #2c5e50;
      --brand-red: #D32F2F;
      --bg-color: #fcfbf9;
    }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", Roboto, sans-serif; 
      background-color: var(--bg-color); 
      margin: 0; padding: 0; overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .input-field { @apply w-full p-3 border rounded-xl bg-white focus:ring-2 focus:ring-green-700 outline-none transition-all; }
    .label-text { @apply text-xs font-bold text-gray-500 mb-1 block uppercase tracking-wider; }
  </style>

  <script type="module">
    import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
    import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';

    const LIFF_ID = "2008861231-EA0Hpl68";
    const RESTAURANT_NAME = "Ëñ©Ë´æÁì¶Áæ©ÂºèÂªöÊàø";
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxHOJOzIGqCnW-ttjB0_OeJ6eIz3iqF3dnYSwGeK4L2vRi6dEuWZ-i_DoM5pHjz9u7PlA/exec";

    const runGAS = async (action, params = {}) => {
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action, ...params })
        });
        return await response.json();
      } catch (err) {
        return { status: 'error', message: 'ÈÄ£Á∑öÂ§±Êïó' };
      }
    };

    const Icon = ({ name, className }) => {
      const paths = {
        menu: "M4 6h16M4 12h16M4 18h16",
        calendar: "M19 4H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V6a2 2 0 00-2-2zm0 0V2m-14 2V2",
        map: "M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z",
        user: "M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2 M12 11a4 4 0 100-8 4 4 0 000 8z",
        gift: "M20 12v10H4V12 M2 7h20v5H2z M12 22V7",
        back: "M15 19l-7-7 7-7",
        phone: "M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07",
        star: "M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z",
        download: "M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 11l5 5 5-5M12 4v12",
        close: "M6 18L18 6M6 6l12 12",
        trash: "M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6",
        edit: "M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7m-4-6l.5-2.5 2.5.5L18 8.5l-5 5-3.5-1.5L14 4.5z",
        cart: "M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z",
        question: "M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4 0 .742-.215 1.42-.588 2H12v2h3.535a4.004 4.004 0 01-7.07 0H5V9h3.228zM12 4a8 8 0 100 16 8 8 0 000-16z",
        info: "M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z",
        ticket: "M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z",
        history: "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z",
        stamp: "M5 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H7a2 2 0 01-2-2V5z"
      };
      return React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", className, fill: "none", viewBox: "0 0 24 24", stroke: "currentColor", strokeWidth: "2" },
        React.createElement("path", { strokeLinecap: "round", strokeLinejoin: "round", d: paths[name] || "" })
      );
    };

    const App = () => {
      const [view, setView] = useState('HOME');
      const [loading, setLoading] = useState(true);
      const [data, setData] = useState({ member: null, faqs: [], promotions: [] });
      const [profile, setProfile] = useState(null);
      const [currentBookingId, setCurrentBookingId] = useState(null);
      
      const handleMemberUpdate = (member) => setData(prev => ({ ...prev, member }));
      const handleMemberDelete = () => setData(prev => ({...prev, member: null}));
      const handleBookingSuccess = (bookingId) => {
        setCurrentBookingId(bookingId);
        setView('PREORDER');
      };

      useEffect(() => {
        const init = async () => {
          let currentUserId = '';
          try {
            if (window.liff) {
              await window.liff.init({ liffId: LIFF_ID });
              if (window.liff.isLoggedIn()) {
                const p = await window.liff.getProfile();
                setProfile(p);
                currentUserId = p.userId;
              }
            }
          } catch (e) { console.warn("LIFF init failed"); }

          const res = await runGAS('getInitialData', { lineUserId: currentUserId });
          if (res.status === 'success') setData(res);
          setLoading(false);
        };
        init();
      }, []);

      if (loading) return (
        React.createElement("div", { className: "fixed inset-0" },
          React.createElement("img", { src: "https://i.ibb.co/93NGBjjh/IMG-6773.jpg", className: "w-full h-full object-cover" })
        )
      );

      const BaseView = ({ title, children, onBack }) => (
        React.createElement("div", { className: "flex flex-col h-screen bg-white animate-fade-in" },
          React.createElement("div", { className: "bg-[#2c5e50] text-white p-4 flex items-center shadow-md h-14 shrink-0" },
            React.createElement("button", { onClick: onBack, className: "mr-3 p-1" }, React.createElement(Icon, { name: "back", className: "w-6 h-6" })),
            React.createElement("h2", { className: "text-lg font-bold" }, title)
          ),
          React.createElement("div", { className: "flex-1 overflow-y-auto" }, children)
        )
      );
      
      const goHome = () => setView('HOME');

      switch(view) {
        case 'HOME': return React.createElement(HomeView, { setView, profile, data });
        case 'MENU': return React.createElement(BaseView, { title: "Á≤æÁ∑ªËèúÂñÆ", onBack: goHome }, React.createElement(MenuView));
        case 'LOCATION': return React.createElement(BaseView, { title: "Â∫óÂÆ∂Ë≥áË®ä", onBack: goHome }, React.createElement(LocationView, { profile }));
        case 'NEWS': return React.createElement(BaseView, { title: "Ê¥ªÂãïËàáÂÑ™ÊÉ†", onBack: goHome }, React.createElement(NewsView, { promotions: data.promotions }));
        case 'FAQ': return React.createElement(BaseView, { title: "Â∏∏Ë¶ãÂïèÈ°å", onBack: goHome }, React.createElement(FaqView, { faqs: data.faqs }));
        case 'BOOKING': return React.createElement(BaseView, { title: "Á∑ö‰∏äË®Ç‰Ωç", onBack: goHome }, React.createElement(BookingView, { member: data.member, profile, onBack: goHome, onBookingSuccess: handleBookingSuccess }));
        case 'MEMBER': return React.createElement(BaseView, { title: "ÊúÉÂì°‰∏≠ÂøÉ", onBack: goHome }, React.createElement(MemberView, { member: data.member, profile, onMemberUpdate: handleMemberUpdate, onMemberDelete: handleMemberDelete, setView }));
        case 'PREORDER': return React.createElement(BaseView, { title: "È†êÂÖàÈªûÈ§ê", onBack: goHome }, React.createElement(PreorderView, { bookingId: currentBookingId, onBack: goHome }));
        case 'MY_BOOKINGS': return React.createElement(BaseView, { title: "ÊàëÁöÑË®Ç‰Ωç", onBack: () => setView('MEMBER') }, React.createElement(MyBookingsView, { profile }));
        case 'POINT_HISTORY': return React.createElement(BaseView, { title: "ÈªûÊï∏Á¥ÄÈåÑ", onBack: () => setView('MEMBER') }, React.createElement(PointHistoryView, { profile }));
        case 'COUPONS': return React.createElement(BaseView, { title: "ÊàëÁöÑÂÑ™ÊÉ†Âà∏", onBack: () => setView('MEMBER') }, React.createElement(CouponsView, { profile }));
        case 'STAMP_CARD': return React.createElement(BaseView, { title: "ÈõÜÈªûÂç°", onBack: () => setView('MEMBER') }, React.createElement(StampCardView, { profile }));
        default: return React.createElement(HomeView, { setView, profile, data });
      }
    };

    const HomeView = ({ setView, profile, data }) => (
      React.createElement("div", { className: "flex flex-col h-full bg-gradient-to-b from-green-50 to-white" },
        React.createElement("div", { className: "bg-white p-4 sticky top-0 z-10 flex justify-between items-center shadow-sm h-14 shrink-0" },
          React.createElement("h1", { className: "font-bold text-[#2c5e50] text-sm" }, 
            profile?.displayName ? `${profile.displayName}, Ê≠°ËøéÂÖâËá®` : RESTAURANT_NAME
          ),
          profile && React.createElement("img", { src: profile.pictureUrl, className: "w-8 h-8 rounded-full border border-[#2c5e50]" })
        ),
        React.createElement("div", { className: "flex-1 overflow-y-auto p-5 space-y-6" },
          React.createElement("div", { className: "relative h-48 rounded-2xl overflow-hidden shadow-xl" },
            React.createElement("img", { src: "https://i.ibb.co/qLFg7gSk/Gemini-Generated-Image-cmj4yzcmj4yzcmj4.png", className: "w-full h-full object-cover" }),
            React.createElement("div", { className: "absolute inset-0 bg-gradient-to-t from-black/80 flex items-end p-5 text-white" },
              React.createElement("div", null,
                React.createElement("h3", { className: "font-bold text-xl" }, "Buongiorno!"),
                React.createElement("p", { className: "text-[10px] opacity-80 uppercase tracking-widest font-bold" }, "ÈáëÈñÄÈÅìÂú∞Áæ©Â§ßÂà©È¢®Âë≥")
              )
            )
          ),
          React.createElement("div", { className: "grid grid-cols-2 gap-4" },
            [
              { id: 'MENU', name: 'Á≤æÁ∑ªËèúÂñÆ', icon: 'menu', color: 'orange' },
              { id: 'BOOKING', name: 'Á∑ö‰∏äË®Ç‰Ωç', icon: 'calendar', color: 'green' },
              { id: 'LOCATION', name: 'Â∫óÂÆ∂Ë≥áË®ä', icon: 'map', color: 'blue' },
              { id: 'MEMBER', name: 'ÊúÉÂì°‰∏≠ÂøÉ', icon: 'user', color: 'purple' },
              { id: 'NEWS', name: 'Ê¥ªÂãïÂÑ™ÊÉ†', icon: 'gift', color: 'red' },
              { id: 'FAQ', name: 'Â∏∏Ë¶ãÂïèÈ°å', icon: 'question', color: 'gray' }
            ].map(btn => (
              React.createElement("button", { key: btn.id, onClick: () => setView(btn.id), className: "h-32 bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-md border border-gray-100 flex flex-col items-center justify-center gap-2 active:scale-95 transition-all relative" },
                React.createElement("div", { className: `w-12 h-12 bg-${btn.color}-50 rounded-full flex items-center justify-center text-${btn.color}-600`}, React.createElement(Icon, { name: btn.icon, className: "w-6 h-6" })),
                React.createElement("span", { className: "font-bold text-gray-700 text-sm" }, btn.name)
              )
            ))
          )
        )
      )
    );

    const MenuView = () => { /* ... No changes ... */ };

    const LocationView = ({ profile }) => {
        const [showFeedback, setShowFeedback] = useState(false);
        const [rating, setRating] = useState(0);
        const [comment, setComment] = useState("");
        const handleSubmitFeedback = async () => {
            if (rating === 0) {
                Swal.fire('Ë´ãÁµ¶ÊòüÁ¥öË©ïÂàÜ', 'Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÈ°ÜÊòü', 'warning');
                return;
            }
            const res = await runGAS('submitFeedback', { lineUserId: profile?.userId, name: profile?.displayName, rating, comment });
            if (res.status === 'success') {
                Swal.fire('ÊÑüË¨ùÊÇ®ÁöÑÂõûÈ•ãÔºÅ', 'ÊÇ®ÁöÑÊÑèË¶ãÊòØÊàëÂÄëÈÄ≤Ê≠•ÁöÑÂãïÂäõ', 'success');
                setShowFeedback(false); setRating(0); setComment("");
            } else {
                Swal.fire('Êèê‰∫§Â§±Êïó', res.message, 'error');
            }
        };
        return React.createElement("div", { className: "p-6 space-y-6" },
            // ... Existing Map and Info ...
            React.createElement("div", { className: "bg-blue-50 p-4 rounded-xl border border-blue-200" },
                React.createElement("h4", { className: "font-bold text-gray-800 mb-2" }, "‰∫§ÈÄöË≥áË®ä"),
                React.createElement("p", { className: "text-sm text-gray-600" }, "üöó ÈôÑËøëË®≠ÊúâÂÖ¨ÂÖ±ÂÅúËªäÂ†¥ÔºåÊ≠•Ë°åÁ¥Ñ5ÂàÜÈêò„ÄÇ"),
                React.createElement("p", { className: "text-sm text-gray-600 mt-1" }, "üöå ÂèØÊê≠‰πòÂÖ¨ËªäËá≥„ÄåÂ§™ÊπñÁ´ô„ÄçÔºåÊ≠•Ë°åÁ¥Ñ3ÂàÜÈêò„ÄÇ")
            ),
            !showFeedback ? 
                React.createElement("button", { onClick: () => setShowFeedback(true), className: "w-full bg-yellow-500 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2" }, React.createElement(Icon, {name:"star", className:"w-5 h-5"}), "ÈªûÊàëÁïô‰∏ãÈ°ßÂÆ¢ÂõûÈ•ã")
                :
                React.createElement("div", { className: "p-4 bg-white rounded-xl shadow-md border" },
                    React.createElement("h3", { className: "font-bold text-gray-700 mb-2" }, "ÊÇ®ÁöÑÂØ∂Ë≤¥ÊÑèË¶ã"),
                    React.createElement("div", { className: "flex justify-center my-4" }, 
                        [1, 2, 3, 4, 5].map(star => React.createElement("button", { key: star, onClick: () => setRating(star) }, React.createElement(Icon, { name: "star", className: `w-8 h-8 ${rating >= star ? 'text-yellow-400 fill-current' : 'text-gray-300'}` })))
                    ),
                    React.createElement("textarea", { value: comment, onChange: e => setComment(e.target.value), className: "input-field", placeholder: "Ë´ãÂàÜ‰∫´ÊÇ®ÁöÑÁî®È§êÈ´îÈ©ó...", rows: 3 }),
                    React.createElement("div", { className: "flex gap-2 mt-2" },
                        React.createElement("button", { onClick: handleSubmitFeedback, className: "w-full bg-green-600 text-white py-2 rounded-lg" }, "ÈÄÅÂá∫"),
                        React.createElement("button", { onClick: () => setShowFeedback(false), className: "w-full bg-gray-200 py-2 rounded-lg" }, "ÂèñÊ∂à")
                    )
                )
        );
    };

    const NewsView = ({ promotions }) => (
        React.createElement("div", { className: "p-4 space-y-4" },
            promotions.map((p, i) => React.createElement("div", { key: i, className: "bg-white rounded-xl shadow-md border overflow-hidden" },
                p.image && React.createElement("img", { src: p.image, className: "w-full h-44 object-cover" }),
                React.createElement("div", { className: "p-4" },
                    p.type === 'event' && React.createElement("div", { className: "text-sm text-red-600 font-bold mb-1 flex items-center gap-1" }, React.createElement(Icon, {name:"calendar", className:"w-4 h-4"}), `Ê¥ªÂãïÊó•ÊúüÔºö${p.eventDate}`),
                    React.createElement("h3", { className: "font-bold text-green-800" }, p.title),
                    React.createElement("p", { className: "text-sm text-gray-500 mt-1" }, p.desc)
                )
            ))
        )
    );

    const FaqView = ({ faqs }) => { /* ... No changes ... */ };

    const BookingView = ({ member, profile, onBack, onBookingSuccess }) => {
        const [form, setForm] = useState({ date: new Date().toISOString().split('T')[0], time: '12:00', adults: 2, children: 0, highChairs: 0, name: member?.name || profile?.displayName || '', phone: member?.phone || '', notes: '', vegetarian: false, seating: '‰∏çÊåáÂÆö', occasion: 'ÁÑ°' });
        // ... same logic as before ...
        
        // Add new dropdowns to the form
        return React.createElement("form", { /* ... */ },
            // ... other fields ...
            React.createElement("div", { className: "p-4 bg-white rounded-xl shadow-sm border" },
                 React.createElement("h3", { className: "font-bold text-gray-700 mb-4" }, "ÂÖ∂‰ªñÈúÄÊ±Ç"),
                 React.createElement("div", { className: "grid grid-cols-2 gap-4" },
                    React.createElement("div", null, 
                        React.createElement("span", { className: "label-text" }, "Â∫ß‰ΩçÂÅèÂ•Ω"), 
                        React.createElement("select", { value: form.seating, onChange: e => setForm({ ...form, seating: e.target.value }), className: "input-field" },
                            React.createElement("option", null, "‰∏çÊåáÂÆö"),
                            React.createElement("option", null, "Èù†Á™ó"),
                            React.createElement("option", null, "ÂåÖÂªÇ"),
                            React.createElement("option", null, "ÂÆâÈùúËßíËêΩ")
                        )
                    ),
                    React.createElement("div", null, 
                        React.createElement("span", { className: "label-text" }, "Áî®È§êÁõÆÁöÑ"), 
                        React.createElement("select", { value: form.occasion, onChange: e => setForm({ ...form, occasion: e.target.value }), className: "input-field" },
                            React.createElement("option", null, "ÁÑ°"),
                            React.createElement("option", null, "ÁîüÊó•"),
                            React.createElement("option", null, "Á¥ÄÂøµÊó•"),
                            React.createElement("option", null, "ÂïÜÂãô")
                        )
                    )
                 )
            ),
             // ... other fields ...
        );
    };

    const MemberView = ({ member, profile, onMemberUpdate, onMemberDelete, setView }) => {
        // ... existing logic for registration & member card ...
        if (member) {
            return React.createElement("div", { className: "p-6" },
                // Member Card Div
                React.createElement("div", { /* ... */ }),
                // Member Actions Grid
                React.createElement("div", { className: "mt-8 grid grid-cols-2 gap-4" },
                    [
                        { id: 'MY_BOOKINGS', name: 'ÊàëÁöÑË®Ç‰Ωç', icon: 'calendar' },
                        { id: 'POINT_HISTORY', name: 'ÈªûÊï∏Á¥ÄÈåÑ', icon: 'history' },
                        { id: 'COUPONS', name: 'ÊàëÁöÑÂÑ™ÊÉ†Âà∏', icon: 'ticket' },
                        { id: 'STAMP_CARD', name: 'ÈõÜÈªûÂç°', icon: 'stamp' }
                    ].map(btn => React.createElement("button", { key: btn.id, onClick: () => setView(btn.id), className: "bg-white p-4 rounded-xl shadow border flex flex-col items-center justify-center gap-2" },
                        React.createElement(Icon, { name: btn.icon, className: "w-8 h-8 text-green-700" }),
                        React.createElement("span", { className: "font-bold text-sm" }, btn.name)
                    ))
                ),
                // Edit/Delete buttons
                React.createElement("div", { /* ... */ })
            );
        }
        // ... registration form ...
    };
    
    // NEW COMPONENTS
    const MyBookingsView = ({ profile }) => { /* ... JSX to list bookings ... */ };
    const PointHistoryView = ({ profile }) => { /* ... JSX to list point history ... */ };
    const CouponsView = ({ profile }) => { /* ... JSX to list coupons ... */ };
    const StampCardView = ({ profile }) => { /* ... JSX for stamp card UI ... */ };

    const PreorderView = ({ bookingId, onBack }) => {
        const menuData = { /* ... updated menu data with `isSpecial` and `allergens` ... */ };
        // ... existing logic ...
        const showAllergens = (allergens) => {
            Swal.fire({ title: 'ÈÅéÊïèÂéüË≥áË®ä', text: `Êú¨Áî¢ÂìÅÂê´Ôºö${allergens}`, icon: 'info' });
        };
        
        return React.createElement("div", { /* ... */ },
            // ... menu categories ...
            React.createElement("div", { /* ... menu items container ... */ },
                menuData.categories.find(c => c.name === activeCategory).items.map(item => React.createElement("div", { key: item.n, className: "..." }, 
                    React.createElement("div", null, 
                        React.createElement("p", { className: "font-bold flex items-center gap-2" }, 
                            item.n,
                            item.isSpecial && React.createElement("span", { className: "text-xs bg-red-500 text-white px-2 py-0.5 rounded-full" }, "Êé®Ëñ¶"),
                            item.allergens && React.createElement("button", { onClick: () => showAllergens(item.allergens) }, React.createElement(Icon, { name: "info", className: "w-5 h-5 text-blue-500" }))
                        ),
                        React.createElement("p", { className: "text-sm text-gray-500" }, `$${item.p}`)
                    ),
                    // ... add to cart button
                ))
            ),
            // ... cart section
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
  </script>
</head>
<body>
  <div id="root"></div>
</body>
</html>