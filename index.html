<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>薩諾瓦義式廚房</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root {
      --brand-green: #2c5e50;
      --brand-red: #D32F2F;
      --bg-color: #fcfbf9;
    }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", Roboto, sans-serif; 
      background-color: var(--bg-color); 
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    .loading-spinner {
      border: 3px solid rgba(44, 94, 80, 0.1);
      border-top: 3px solid var(--brand-green);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    ::-webkit-scrollbar { width: 0px; background: transparent; }
  </style>

  <script type="module">
    import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
    import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';

    const LIFF_ID = "2008861231-EA0Hpl68";
    const RESTAURANT_NAME = "薩諾瓦義式廚房";
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxHOJOzIGqCnW-ttjB0_OeJ6eIz3iqF3dnYSwGeK4L2vRi6dEuWZ-i_DoM5pHjz9u7PlA/exec";

    const runGAS = async (action, params = {}) => {
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action, ...params })
        });
        return await response.json();
      } catch (err) {
        console.error("GAS Error:", err);
        return { status: 'error', message: '連線失敗' };
      }
    };

    const Icon = ({ name, className }) => {
      const paths = {
        menu: "M4 6h16M4 12h16M4 18h16",
        calendar: "M19 4H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V6a2 2 0 00-2-2zm0 0V2m-14 2V2",
        map: "M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z M15 11a3 3 0 11-6 0 3 3 0 016 0z",
        user: "M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2 M12 11a4 4 0 100-8 4 4 0 000 8z",
        gift: "M20 12v10H4V12 M2 7h20v5H2z M12 22V7 M12 7H7.5a2.5 2.5 0 010-5C11 2 12 7 12 7z",
        chat: "M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7",
        back: "M15 19l-7-7 7-7",
        phone: "M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6",
        chevronLeft: "M15 19l-7-7 7-7"
      };
      return React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", className, fill: "none", viewBox: "0 0 24 24", stroke: "currentColor", strokeWidth: "2" },
        React.createElement("path", { strokeLinecap: "round", strokeLinejoin: "round", d: paths[name] || "" })
      );
    };

    const App = () => {
      const [view, setView] = useState('HOME');
      const [loading, setLoading] = useState(true);
      const [data, setData] = useState({ member: null, faqs: [], promotions: [] });
      const [profile, setProfile] = useState(null);

      useEffect(() => {
        const init = async () => {
          let currentUserId = '';
          let userProfile = null;
          try {
            if (window.liff) {
              const liffPromise = window.liff.init({ liffId: LIFF_ID });
              const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('LIFF init timeout')), 5000));
              await Promise.race([liffPromise, timeoutPromise]);
              if (window.liff.isLoggedIn()) {
                const p = await window.liff.getProfile();
                userProfile = p;
                currentUserId = p.userId;
              }
            }
          } catch (e) { console.warn("LIFF failed or timed out. Continuing as guest.", e); }
          
          setProfile(userProfile);

          try {
            const res = await runGAS('getInitialData', { lineUserId: currentUserId });
            if (res.status === 'success') setData(res);
            else Swal.fire('資料載入失敗', res.message, 'error');
          } catch (e) {
            Swal.fire('網路連線錯誤', '無法從後端獲取資料', 'error');
          } finally {
            setLoading(false);
          }
        };
        init();
      }, []);

      if (loading) {
        return (
          React.createElement("div", { className: "fixed inset-0 bg-white flex flex-col items-center justify-center p-8 text-center" },
            React.createElement("div", { className: "loading-spinner mb-6" }),
            React.createElement("h2", { className: "text-lg font-bold text-[#2c5e50]" }, RESTAURANT_NAME),
            React.createElement("p", { className: "text-gray-400 text-xs mt-3" }, "正在載入美味資訊...")
          )
        );
      }
      
      const BaseView = ({ title, children, onBack }) => (
         React.createElement("div", { className: "flex flex-col h-full bg-white animate-fade-in" },
            React.createElement("div", { className: "bg-[#2c5e50] text-white p-4 flex items-center shadow-md h-14 shrink-0" },
              React.createElement("button", { onClick: onBack, className: "mr-3 p-1" }, React.createElement(Icon, { name: "back", className: "w-6 h-6" })),
              React.createElement("h2", { className: "text-lg font-bold" }, title)
            ),
            React.createElement("div", { className: "flex-1 overflow-y-auto" }, children)
          )
      );

      switch (view) {
        case 'HOME': return React.createElement(HomeView, { setView, profile, data });
        case 'MENU': return React.createElement(BaseView, { title: "精選菜單", onBack: () => setView('HOME') }, React.createElement(MenuView));
        case 'LOCATION': return React.createElement(BaseView, { title: "門市資訊", onBack: () => setView('HOME') }, React.createElement(LocationView));
        case 'NEWS': return React.createElement(BaseView, { title: "最新優惠", onBack: () => setView('HOME') }, React.createElement(NewsView, { promotions: data.promotions }));
        case 'FAQ': return React.createElement(BaseView, { title: "常見問題", onBack: () => setView('HOME') }, React.createElement(FaqView, { faqs: data.faqs }));
        case 'BOOKING': return React.createElement(BaseView, { title: "線上訂位", onBack: () => setView('HOME') }, React.createElement(BookingView, { member: data.member, userProfile: profile, onBack: () => setView('HOME') }));
        case 'MEMBER': return React.createElement(BaseView, { title: "會員中心", onBack: () => setView('HOME') }, React.createElement(MemberView, { member: data.member, userProfile: profile, onRegister: (m) => setData({ ...data, member: m }) }));
        default: return React.createElement(HomeView, { setView, profile, data });
      }
    };
    
    const HomeView = ({ setView, profile, data }) => (
      React.createElement("div", { className: "flex flex-col h-full bg-gray-50" },
        React.createElement("div", { className: "bg-white p-4 sticky top-0 z-10 flex justify-between items-center shadow-sm h-14 shrink-0" },
          React.createElement("h1", { className: "font-bold text-[#2c5e50] text-lg" }, RESTAURANT_NAME),
          profile && React.createElement("img", { src: profile.pictureUrl, className: "w-8 h-8 rounded-full border border-[#2c5e50]" })
        ),
        React.createElement("div", { className: "flex-1 overflow-y-auto p-5 space-y-6" },
          React.createElement("div", { className: "relative h-44 rounded-2xl overflow-hidden shadow-lg" },
            React.createElement("img", { src: "https://i.ibb.co/qLFg7gSk/Gemini-Generated-Image-cmj4yzcmj4yzcmj4.png", className: "w-full h-full object-cover" }),
            React.createElement("div", { className: "absolute inset-0 bg-gradient-to-t from-black/70 flex items-end p-5 text-white" },
              React.createElement("div", null,
                React.createElement("h3", { className: "font-bold text-xl" }, "Buongiorno!"),
                React.createElement("p", { className: "text-[10px] opacity-80 uppercase tracking-widest font-bold" }, "金門道地義大利風味")
              )
            )
          ),
          React.createElement("div", { className: "grid grid-cols-2 gap-4" },
            [
              { id: 'MENU', name: '精選菜單', icon: 'menu', color: 'orange' },
              { id: 'BOOKING', name: '線上訂位', icon: 'calendar', color: 'green' },
              { id: 'LOCATION', name: '門市資訊', icon: 'map', color: 'blue' },
              { id: 'MEMBER', name: '會員中心', icon: 'user', color: 'purple' },
              { id: 'NEWS', name: '最新優惠', icon: 'gift', color: 'red' },
              { id: 'FAQ', name: '常見問題', icon: 'chat', color: 'gray' }
            ].map(btn => (
              React.createElement("button", { key: btn.id, onClick: () => setView(btn.id), className: "h-32 bg-white rounded-2xl shadow-sm flex flex-col items-center justify-center gap-2 active:bg-gray-100 transition-colors relative" },
                React.createElement("div", { className: `w-10 h-10 bg-${btn.color}-50 rounded-full flex items-center justify-center text-${btn.color}-500`}, React.createElement(Icon, { name: btn.icon, className: "w-6 h-6" })),
                React.createElement("span", { className: "font-bold text-gray-700 text-xs" }, btn.name),
                (btn.id === 'MEMBER' && !data.member) && React.createElement("div", { className: "absolute top-4 right-4 w-2 h-2 bg-red-500 rounded-full animate-pulse" })
              )
            ))
          ),
          React.createElement("div", { className: "py-10 text-center" }, React.createElement("p", { className: "text-[10px] text-gray-300 font-bold uppercase tracking-widest" }, "Since 2014"))
        )
      )
    );
    
    // --- 子畫面組件們 ---
    const MenuView = () => React.createElement("div",{className:"p-4 space-y-4"}, React.createElement("img",{src:"https://i.ibb.co/QFTKgJ1B/2023-03-25.webp",className:"w-full rounded shadow"}), React.createElement("img",{src:"https://i.ibb.co/hJ6cfgjM/2025-12-28.webp",className:"w-full rounded shadow"}));
    const LocationView = () => React.createElement("div",{className:"p-6 space-y-6"}, React.createElement("div",{className:"w-full h-48 bg-gray-100 rounded-xl flex items-center justify-center text-gray-400"},"MAP"), React.createElement("div",{className:"space-y-4"}, React.createElement("div",{className:"flex gap-4"}, React.createElement(Icon,{name:"map",className:"w-6 h-6 text-[#2c5e50]"}), React.createElement("div",null, React.createElement("h4",{className:"font-bold"},"地址"), React.createElement("p",{className:"text-gray-600"},"金門縣金湖鎮太湖路二段3巷6號"))), React.createElement("div",{className:"flex gap-4"}, React.createElement(Icon,{name:"calendar",className:"w-6 h-6 text-[#2c5e50]"}), React.createElement("div",null, React.createElement("h4",{className:"font-bold"},"營業時間"), React.createElement("p",{className:"text-gray-600"},"週二至週日 11:00-14:00/17:00-20:30")))), React.createElement("a",{href:"tel:082332530",className:"w-full bg-gray-800 text-white py-4 rounded-xl flex items-center justify-center gap-2 font-bold shadow-lg"}, React.createElement(Icon,{name:"phone",className:"w-5 h-5"})," 撥打電話"));
    const NewsView = ({promotions}) => React.createElement("div",{className:"p-4 space-y-4"}, promotions.map((p,i)=>React.createElement("div",{key:i,className:"bg-white rounded-xl shadow-md border overflow-hidden"}, React.createElement("img",{src:p.image,className:"w-full h-40 object-cover"}), React.createElement("div",{className:"p-4"}, React.createElement("h3",{className:"font-bold"},p.title), React.createElement("p",{className:"text-sm text-gray-500"},p.desc)))));
    const FaqView = ({faqs}) => React.createElement("div",{className:"p-4 space-y-3"}, faqs.map((f,i)=>React.createElement("details",{key:i,className:"bg-gray-50 rounded-xl border p-4 group list-none"}, React.createElement("summary",{className:"font-bold cursor-pointer flex justify-between items-center"},f.q, React.createElement(Icon,{name:"chevronLeft",className:"w-4 h-4 -rotate-90 group-open:rotate-90 transition-transform"})), React.createElement("p",{className:"text-sm text-gray-600 mt-2 pt-2 border-t"},f.a))));
    const BookingView = ({ member, userProfile, onBack }) => { const [form, setForm] = useState({ date: new Date().toISOString().split('T')[0], time: '12:00', adults: 2, children: 0, name: member?.name || userProfile?.displayName || '', phone: member?.phone || '' }); const [submitting, setSubmitting] = useState(false); const handleSubmit = async e => { e.preventDefault(); setSubmitting(true); const res = await runGAS('booking', { ...form, lineUserId: userProfile?.userId }); if(res.status === 'success') { await Swal.fire('預約成功', '我們將盡快為您安排', 'success'); onBack(); } else { Swal.fire('預約失敗', res.message, 'error'); } setSubmitting(false); }; return React.createElement("form",{onSubmit:handleSubmit, className:"p-6 space-y-4"}, React.createElement("input",{type:"date", className:"w-full p-3 border rounded-xl", value:form.date, onChange:e=>setForm({...form,date:e.target.value})}), React.createElement("input",{type:"time", className:"w-full p-3 border rounded-xl", value:form.time, onChange:e=>setForm({...form,time:e.target.value})}), React.createElement("input",{type:"number", placeholder:"大人", className:"w-full p-3 border rounded-xl", value:form.adults, onChange:e=>setForm({...form,adults:parseInt(e.target.value)})}), React.createElement("input",{type:"text", placeholder:"姓名", className:"w-full p-3 border rounded-xl", value:form.name, onChange:e=>setForm({...form,name:e.target.value})}), React.createElement("input",{type:"tel", placeholder:"電話", className:"w-full p-3 border rounded-xl", value:form.phone, onChange:e=>setForm({...form,phone:e.target.value})}), React.createElement("button",{type:"submit", disabled:submitting, className:"w-full bg-[#D32F2F] text-white py-4 rounded-xl font-bold shadow-lg"}, submitting ? "處理中..." : "確認訂位"));};
    const MemberView = ({ member, userProfile, onRegister }) => { const [form, setForm] = useState({ name: userProfile?.displayName || '', phone: '' }); const [submitting, setSubmitting] = useState(false); const handleSubmit = async e => { e.preventDefault(); setSubmitting(true); const res = await runGAS('register', { ...form, lineUserId: userProfile?.userId }); if(res.status === 'success') { onRegister(res.member); Swal.fire('註冊成功!', '', 'success'); } else { Swal.fire('註冊失敗', res.message, 'error'); } setSubmitting(false); }; if(member) return React.createElement("div",{className:"p-6"}, React.createElement("div",{className:"bg-gradient-to-br from-[#2c5e50] to-black p-6 rounded-2xl text-white shadow-xl"}, React.createElement("div",{className:"text-xl font-bold mb-8"},RESTAURANT_NAME), React.createElement("div",{className:"flex justify-between items-end"}, React.createElement("div",null, React.createElement("p",{className:"text-sm opacity-80"},member.name), React.createElement("p",{className:"tracking-widest"},member.phone)), React.createElement("div",{className:"text-right"}, React.createElement("p",{className:"text-[10px] opacity-60"},"POINTS"), React.createElement("p",{className:"text-2xl font-bold"},member.points))))); return React.createElement("form",{onSubmit:handleSubmit, className:"p-6 space-y-4"}, React.createElement("h3",{className:"font-bold text-[#2c5e50] text-center text-xl"},"新會員註冊"), React.createElement("input",{type:"text", placeholder:"您的姓名", className:"w-full p-3 border rounded-xl", required:true, value:form.name, onChange:e=>setForm({...form,name:e.target.value})}), React.createElement("input",{type:"tel", placeholder:"手機號碼", className:"w-full p-3 border rounded-xl", required:true, value:form.phone, onChange:e=>setForm({...form,phone:e.target.value})}), React.createElement("button",{type:"submit", disabled:submitting, className:"w-full bg-[#2c5e50] text-white py-4 rounded-xl font-bold shadow-md"}, submitting ? "處理中..." : "立即加入")); };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
  </script>
</head>
<body>
  <div id="root"></div>
</body>
</html>