<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>薩諾瓦義式廚房</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root {
      --brand-green: #2c5e50;
      --brand-red: #D32F2F;
      --bg-color: #fcfbf9;
    }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", Roboto, sans-serif; 
      background-color: var(--bg-color); 
      color: #333; 
    }
    ::-webkit-scrollbar { width: 0px; background: transparent; }
    .swal2-popup { font-family: inherit !important; border-radius: 1rem !important; }
    .swal2-confirm { background-color: #2c5e50 !important; }
    .swal2-styled.swal2-cancel { background-color: #718096 !important; }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'italian-green': '#2c5e50',
            'italian-red': '#D32F2F',
            'italian-white': '#fcfbf9',
            'italian-dark': '#1a3a32',
          },
          animation: {
            'slide-up': 'slideUp 0.3s ease-out',
            'fade-in': 'fadeIn 0.3s ease-out',
          },
          keyframes: {
            slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
          }
        }
      }
    }
  </script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    
    // ================= 全域設定 =================
    const LIFF_ID = "2008861231-EA0Hpl68"; 
    const RESTAURANT_NAME = "薩諾瓦義式廚房";
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxHOJOzIGqCnW-ttjB0_OeJ6eIz3iqF3dnYSwGeK4L2vRi6dEuWZ-i_DoM5pHjz9u7PlA/exec";

    // ================= 通訊與工具函式 =================
    const showAlert = (title, text, icon = 'info') => Swal.fire({ title, text, icon, confirmButtonText: '確定', confirmButtonColor: '#2c5e50' });
    const showConfirm = (title, text, confirmBtnTxt = '確定', cancelBtnTxt = '取消') => Swal.fire({ title, text, icon: 'question', showCancelButton: true, confirmButtonText: confirmBtnTxt, cancelButtonText: cancelBtnTxt, confirmButtonColor: '#2c5e50' });
    const runGoogleScript = async (action, params = {}) => {
      const payload = { action, ...params };
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'text/plain;charset=utf-8' } });
        return await response.json();
      } catch (error) {
        console.error('GAS Error:', error);
        return { status: 'error', message: '連線失敗' };
      }
    };
    const Icon = ({ name, className }) => {
      const icons = {
        menu: "M4 6h16M4 12h16M4 18h16", calendar: "M19 4H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V6a2 2 0 00-2-2zm0 0V2m-14 2V2", map: "M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z M15 11a3 3 0 11-6 0 3 3 0 016 0z", user: "M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2 M12 11a4 4 0 100-8 4 4 0 000 8z", gift: "M20 12v10H4V12 M2 7h20v5H2z M12 22V7 M12 7H7.5a2.5 2.5 0 010-5C11 2 12 7 12 7z M12 7h4.5a2.5 2.5 0 000-5C13 2 12 7 12 7z", chat: "M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z", x: "M18 6L6 18M6 6l12 12", chevronLeft: "M15 19l-7-7 7-7", phone: "M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z", clock: "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z", edit: "M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z", cake: "M21 16v2a4 4 0 01-4 4H7a4 4 0 01-4-4v-2c0-.55.45-1 1-1h16c.55 0 1 .45 1 1zm-1-5a2 2 0 11-4 0 2 2 0 014 0zm-8 0a2 2 0 11-4 0 2 2 0 014 0zm8-6a2 2 0 01-2 2h-1.5a2 2 0 01-2-2V4a1 1 0 011-1h2.5a1 1 0 011 1v1zm-8 0a2 2 0 01-2 2H7.5a2 2 0 01-2-2V4a1 1 0 011-1h2.5a1 1 0 011 1v1z"
      };
      return (<svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d={icons[name] || ''} /></svg>);
    };

    // ================= 元件區 =================
    const MenuView = ({ onBack }) => (/* ... implementation from previous turns ... */);
    const LocationView = ({ onBack }) => (/* ... implementation from previous turns ... */);
    const NewsView = ({ onBack, promotions }) => (/* ... implementation from previous turns ... */);
    const FaqView = ({ onBack, faqs, onOpenChat }) => (/* ... implementation from previous turns ... */);
    const ChatOverlay = ({ onClose }) => (/* ... implementation from previous turns ... */);
    const PreorderView = ({ onSuccess, onCancel }) => (/* ... implementation from previous turns ... */);
    
    const MemberView = ({ onBack, member, onRegister, userProfile }) => {
        const [regData, setRegData] = useState({ name: userProfile?.displayName || '', phone: '', birthday: '' });
        const [loading, setLoading] = useState(false);
        const handleRegSubmit = async (e) => { e.preventDefault(); if (!/^09\d{8}$/.test(regData.phone)) return showAlert('格式錯誤', '手機號碼需為09開頭10碼'); setLoading(true); await onRegister(regData); setLoading(false); };
        return (<div className="flex flex-col h-full bg-gray-50"><div className="bg-italian-green text-white p-4 flex items-center shadow-md"><button onClick={onBack} className="mr-3"><Icon name="chevronLeft" className="w-6 h-6" /></button><h2 className="text-lg font-bold">會員中心</h2></div><div className="flex-1 overflow-y-auto p-6">{member ? (<div><h3 className="text-xl font-bold">Hi, {member.name}</h3><p>點數: {member.points}</p></div>) : (<div className="bg-white p-6 rounded-lg shadow-md"><h3 className="text-xl font-bold mb-4 text-center">歡迎加入會員</h3><form onSubmit={handleRegSubmit} className="space-y-4"><input type="text" placeholder="姓名 (必填)" required className="w-full p-3 border rounded-lg bg-gray-50" value={regData.name} onChange={e => setRegData({...regData, name: e.target.value})} /><input type="tel" placeholder="手機 09xxxxxxxx (必填)" required className="w-full p-3 border rounded-lg bg-gray-50" value={regData.phone} onChange={e => setRegData({...regData, phone: e.target.value})} /><div className="bg-gradient-to-br from-red-50 to-orange-50 border border-orange-200 rounded-xl p-4 mt-2"><div className="flex items-start gap-3"><Icon name="cake" className="w-8 h-8 text-italian-red mt-1"/><div className="flex-1"><h4 className="font-bold text-orange-800">壽星專屬好禮</h4><p className="text-xs text-gray-500 mb-2">填寫生日，生日當月招待精緻甜點！</p><input type="date" className="w-full p-2 border rounded-lg bg-white" value={regData.birthday} onChange={e => setRegData({...regData, birthday: e.target.value})} /></div></div></div><button type="submit" disabled={loading} className="w-full bg-italian-green text-white p-3 rounded-lg font-bold mt-2">{loading ? '註冊中...' : '立即註冊'}</button></form></div>)}</div></div>);
    };

    const BookingForm = ({ onBack, member, userProfile, onSuccessWithData }) => {
        const [step, setStep] = useState(1);
        const [loading, setLoading] = useState(false);
        const today = new Date().toISOString().split('T')[0];
        const [formData, setFormData] = useState({ date: today, time: '18:00', adults: 2, children: 0, highChairs: 0, name: member?.name || userProfile?.displayName || '', phone: member?.phone || '', notes: '' });
        useEffect(() => { const s = localStorage.getItem('b_info'); if(s) { const p = JSON.parse(s); setFormData(prev => ({...prev, name:member?.name||p.name||prev.name, phone:member?.phone||p.phone||prev.phone})); } }, [member]);
        const Counter = ({ label, value, onChange, min = 0 }) => (<div className="flex justify-between items-center bg-gray-50 p-3 rounded-lg"><span className="font-medium">{label}</span><div className="flex items-center gap-3"><button type="button" onClick={() => onChange(Math.max(min, value - 1))} className="w-8 h-8 rounded-full bg-gray-200">-</button><span className="w-6 text-center font-bold text-lg">{value}</span><button type="button" onClick={() => onChange(value + 1)} className="w-8 h-8 rounded-full bg-italian-green text-white">+</button></div></div>);
        const handleSubmit = async (e) => { e.preventDefault(); if (!/^09\d{8}$/.test(formData.phone)) return showAlert('格式錯誤', '手機號碼需為09開頭10碼'); setLoading(true); const res = await runGoogleScript('booking', { ...formData, lineUserId: userProfile?.userId }); setLoading(false); if (res.status === 'success') { localStorage.setItem('b_info', JSON.stringify({ name: formData.name, phone: formData.phone })); onSuccessWithData(formData); } else { showAlert('預約失敗', res.message, 'error'); }};
        const timeSlots = ['11:00','11:30','12:00','12:30','13:00','17:00','17:30','18:00','18:30','19:00','19:30','20:00'];
        return (<div className="fixed inset-0 bg-white z-40 flex flex-col animate-slide-up"><div className="bg-italian-green text-white p-4 flex items-center shadow-md"><button onClick={onBack} className="mr-3"><Icon name="chevronLeft" className="w-6 h-6"/></button><h2 className="text-lg font-bold">立即訂位</h2></div><div className="flex-1 overflow-y-auto p-6"><form onSubmit={handleSubmit} className="space-y-6">{step === 1 ? (<div className="space-y-6"><div><label className="font-bold block mb-2">日期</label><input type="date" min={today} className="w-full p-3 border rounded-lg" value={formData.date} onChange={e=>setFormData({...formData, date:e.target.value})} required/></div><div><label className="font-bold block mb-2">時間</label><div className="grid grid-cols-4 gap-2">{timeSlots.map(t=>(<button type="button" key={t} onClick={()=>setFormData({...formData,time:t})} className={`py-2 rounded-lg border ${formData.time===t ? 'bg-italian-green text-white':'bg-white'}`}>{t}</button>))}</div></div><div className="space-y-3"><label className="font-bold block">人數與需求</label><Counter label="大人" value={formData.adults} onChange={v=>setFormData({...formData,adults:v})} min={1}/><Counter label="小孩" value={formData.children} onChange={v=>setFormData({...formData,children:v})}/>{formData.children>0&&(<div className="flex justify-between items-center bg-orange-50 p-3 rounded-lg"><span className="font-medium">需要兒童椅</span><div className="flex items-center gap-2"><input type="checkbox" className="w-5 h-5 accent-italian-green" checked={formData.highChairs > 0} onChange={e=>setFormData({...formData, highChairs: e.target.checked ? 1 : 0})}/>{formData.highChairs > 0 && (<select value={formData.highChairs} onChange={e=>setFormData({...formData, highChairs: parseInt(e.target.value)})} className="p-1 rounded border bg-white">{[...Array(formData.children).keys()].map(i=><option key={i+1} value={i+1}>{i+1} 張</option>)}</select>)}</div></div>)}</div><button type="button" onClick={()=>setStep(2)} className="w-full bg-italian-dark text-white py-3 rounded-lg font-bold mt-4">下一步：填寫聯絡資料</button></div>) : (<div className="space-y-5"><div className="bg-gray-50 p-3 rounded-lg space-y-1"><div className="flex justify-between"><span className="font-bold">時間</span><span>{formData.date} {formData.time}</span></div><div className="flex justify-between"><span className="font-bold">人數</span><span>{formData.adults}大 {formData.children}小</span></div></div><input type="text" placeholder="訂位大名" required className="w-full p-3 border rounded-lg" value={formData.name} onChange={e=>setFormData({...formData,name:e.target.value})}/><input type="tel" placeholder="聯絡電話" required className="w-full p-3 border rounded-lg" value={formData.phone} onChange={e=>setFormData({...formData,phone:e.target.value})}/><textarea placeholder="其他備註..." rows="3" className="w-full p-3 border rounded-lg" value={formData.notes} onChange={e=>setFormData({...formData,notes:e.target.value})}/><div className="flex gap-3 pt-2"><button type="button" onClick={()=>setStep(1)} className="flex-1 bg-gray-200 py-3 rounded-lg font-bold">返回修改</button><button type="submit" disabled={loading} className="flex-[2] bg-italian-red text-white py-3 rounded-lg font-bold">{loading?'處理中...':'確認預約'}</button></div></div>)}</form></div></div>);
    };

    // ================= 主 App =================
    const App = () => {
        const [view, setView] = useState('HOME');
        const [loading, setLoading] = useState(true);
        const [profile, setProfile] = useState(null);
        const [member, setMember] = useState(null);
        const [appData, setAppData] = useState({ faqs: [], promotions: [] });
        const [tempBookingInfo, setTempBookingInfo] = useState(null);

        useEffect(() => {
            const init = async () => {
                setLoading(true);
                let p = null;
                try {
                    if (window.liff) { await window.liff.init({ liffId: LIFF_ID }); if (window.liff.isLoggedIn()) p = await window.liff.getProfile(); }
                } catch(e) { console.error('LIFF Error', e); }
                setProfile(p);
                const data = await runGoogleScript('getInitialData', { lineUserId: p?.userId });
                if(data.status === 'success') { setMember(data.member); setAppData({ faqs: data.faqs, promotions: data.promotions }); }
                setLoading(false);
            };
            init();
        }, []);

        const handleRegister = async (regData) => {
            const res = await runGoogleScript('register', { ...regData, lineUserId: profile?.userId });
            if(res.status === 'success') { setMember(res.member); setView('HOME'); showAlert('註冊成功', '恭喜加入會員！已贈送100點。', 'success'); } else { showAlert('註冊失敗', res.message, 'error'); }
        };
        
        const handleBookingSuccess = (bookingDetails) => {
            setTempBookingInfo(bookingDetails);
            try {
                if (window.liff && window.liff.isInClient()) {
                    const msg = `【訂位成功通知】\n- 餐廳：${RESTAURANT_NAME}\n- 姓名：${bookingDetails.name}\n- 電話：${bookingDetails.phone}\n- 日期：${bookingDetails.date} ${bookingDetails.time}\n- 人數：${bookingDetails.adults}大 ${bookingDetails.children}小`;
                    window.liff.sendMessages([{ type: 'text', text: msg }]);
                }
            } catch (e) { console.error("LIFF send message failed", e); }
            showConfirm('訂位成功！', '您的訂位已確認，是否要預先點餐以節省您的等候時間？', '預先點餐', '不用了').then(res => setView(res.isConfirmed ? 'PREORDER' : 'SUCCESS'));
        };

        const handlePreorderSuccess = async (orderItems) => { /* ... implementation ... */ };
        const checkMemberAndGo = (targetView) => {
            if (member) setView(targetView); else showConfirm('會員限定功能', '立即註冊會員即可使用此功能，是否前往註冊？', '前往註冊').then(res => res.isConfirmed && setView('MEMBER'));
        };

        if (loading) return <div className="flex h-full items-center justify-center"><div className="w-10 h-10 border-4 border-t-italian-green rounded-full animate-spin"></div></div>;

        const renderView = () => {
            switch(view) {
                case 'MENU': return <MenuView onBack={() => setView('HOME')} />;
                case 'LOCATION': return <LocationView onBack={() => setView('HOME')} />;
                case 'NEWS': return <NewsView onBack={() => setView('HOME')} promotions={appData.promotions} />;
                case 'MEMBER': return <MemberView onBack={() => setView('HOME')} member={member} onRegister={handleRegister} userProfile={profile} />;
                case 'FAQ': return <FaqView onBack={() => setView('HOME')} faqs={appData.faqs} onOpenChat={() => setView('CHAT')} />;
                case 'BOOKING': return <BookingForm onBack={() => setView('HOME')} member={member} userProfile={profile} onSuccessWithData={handleBookingSuccess}/>;
                case 'CHAT': return <ChatOverlay onClose={() => setView('HOME')} />;
                case 'PREORDER': return <PreorderView onSuccess={handlePreorderSuccess} onCancel={() => setView('SUCCESS')} />;
                case 'SUCCESS': return <div className="p-8 text-center flex flex-col items-center justify-center h-full"><h2 className="text-2xl font-bold">預約完成</h2><p>期待您的光臨！</p><button onClick={() => setView('HOME')} className="mt-4 bg-gray-200 p-2 rounded">返回首頁</button></div>;
                default: return <div className="flex-1 flex flex-col"><header className="p-4"><h1 className="text-2xl font-bold">{RESTAURANT_NAME}</h1><p className="text-sm text-gray-500">Hi, {profile?.displayName || '訪客'}</p></header><main className="flex-1 overflow-y-auto p-4 grid grid-cols-2 gap-4"><button onClick={() => setView('MENU')} className="bg-orange-100 p-4 rounded-lg flex flex-col items-center justify-center gap-2"><Icon name="menu" className="w-8 h-8"/>線上菜單</button><button onClick={() => checkMemberAndGo('BOOKING')} className="bg-green-100 p-4 rounded-lg flex flex-col items-center justify-center gap-2"><Icon name="calendar" className="w-8 h-8"/>立即訂位</button><button onClick={() => setView('LOCATION')} className="bg-blue-100 p-4 rounded-lg flex flex-col items-center justify-center gap-2"><Icon name="map" className="w-8 h-8"/>門市資訊</button><button onClick={() => setView('MEMBER')} className="bg-purple-100 p-4 rounded-lg relative flex flex-col items-center justify-center gap-2"><Icon name="user" className="w-8 h-8"/>會員中心{!member && <span className="absolute top-2 right-2 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>}</button><button onClick={() => setView('NEWS')} className="bg-red-100 p-4 rounded-lg flex flex-col items-center justify-center gap-2"><Icon name="gift" className="w-8 h-8"/>最新優惠</button><button onClick={() => setView('FAQ')} className="bg-gray-100 p-4 rounded-lg flex flex-col items-center justify-center gap-2"><Icon name="chat" className="w-8 h-8"/>客服中心</button></main></div>;
            }
        };

        return <div className="relative min-h-screen bg-white max-w-md mx-auto shadow-2xl overflow-hidden h-screen flex flex-col">{renderView()}</div>;
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
